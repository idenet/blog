"use strict";(self.webpackChunkstudy_note=self.webpackChunkstudy_note||[]).push([[1290],{1834:(n,s,a)=>{a.r(s),a.d(s,{data:()=>t});const t={key:"v-1edf2165",path:"/vue/example/computed.html",title:"计算属性",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"首次执行",slug:"首次执行",children:[{level:3,title:"创建一个计算属性Watcher",slug:"创建一个计算属性watcher",children:[]}]},{level:2,title:"defineComputed",slug:"definecomputed",children:[]},{level:2,title:"生成执行执行函数",slug:"生成执行执行函数",children:[]},{level:2,title:"执行匿名函数",slug:"执行匿名函数",children:[]},{level:2,title:"开始真正的computed执行",slug:"开始真正的computed执行",children:[{level:3,title:"执行 watcher.evaluate()",slug:"执行-watcher-evaluate",children:[]},{level:3,title:"执行 watcher.depend()",slug:"执行-watcher-depend",children:[]}]},{level:2,title:"来思考一些问题",slug:"来思考一些问题",children:[]},{level:2,title:"更新数据",slug:"更新数据",children:[]},{level:2,title:"总结",slug:"总结",children:[]}],filePathRelative:"vue/example/computed.md",git:{updatedTime:1641131697e3}}},4971:(n,s,a)=>{a.r(s),a.d(s,{default:()=>os});var t=a(6252),e=a(9067);const o=(0,t._)("h1",{id:"计算属性",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#计算属性","aria-hidden":"true"},"#"),(0,t.Uk)(" 计算属性")],-1),c=(0,t._)("p",null,"关于计算属性，我们看官网文档的描述：",-1),p=(0,t._)("p",null,[(0,t._)("strong",null,"计算属性是基于他们的响应式依赖进行缓存的，只在相关响应式依赖发生改变时它们才会重新求值")],-1),l=(0,t._)("p",null,"那么如何解析这句话？我们从简单的例子开始",-1),k=(0,t._)("div",{class:"language-html ext-html line-numbers-mode"},[(0,t._)("pre",{class:"language-html"},[(0,t._)("code",null,[(0,t._)("span",{class:"token doctype"},[(0,t._)("span",{class:"token punctuation"},"<!"),(0,t._)("span",{class:"token doctype-tag"},"DOCTYPE"),(0,t.Uk)(),(0,t._)("span",{class:"token name"},"html"),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("html")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"lang"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("en"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("head")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("meta")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"charset"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("UTF-8"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("meta")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"http-equiv"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("X-UA-Compatible"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"content"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("IE=edge"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("meta")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"name"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("viewport"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"content"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("width=device-width, initial-scale=1.0"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("title")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("computed"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("title")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("script")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"src"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("../../dist/vue.js"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t._)("span",{class:"token script"}),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("script")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("head")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("body")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("div")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"id"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("app"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("div")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("{{compA}}"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("div")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("div")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("script")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t._)("span",{class:"token script"},[(0,t._)("span",{class:"token language-javascript"},[(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" vm "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Vue"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      el"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'#app'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n      data"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        a"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token number"},"1"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n      computed"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token function"},"compA"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("a "),(0,t._)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t._)("span",{class:"token number"},"1"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  ")])]),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("script")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("body")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("html")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"23"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"24"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"25"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"26"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"27"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"28"),(0,t._)("br")])],-1),u=(0,t._)("p",null,[(0,t.Uk)("查看源码，我们现在先分析首次执行，"),(0,t._)("code",null,"computed"),(0,t.Uk)("是如何做的。")],-1),_=(0,t._)("h2",{id:"首次执行",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#首次执行","aria-hidden":"true"},"#"),(0,t.Uk)(" 首次执行")],-1),r=(0,t._)("ol",null,[(0,t._)("li",null,[(0,t.Uk)("初始化"),(0,t._)("code",null,"computed")])],-1),i=(0,t._)("p",null,[(0,t.Uk)("在我们"),(0,t._)("code",null,"new Vue"),(0,t.Uk)("执行"),(0,t._)("code",null,"_init"),(0,t.Uk)("方法的时候，我们会执行到"),(0,t._)("code",null,"initState"),(0,t.Uk)("。这里是初始化大多数关键"),(0,t._)("code",null,"options"),(0,t.Uk)("的地方，并且会将其挂载到"),(0,t._)("code",null,"$options"),(0,t.Uk)("上，这样我们就能通过"),(0,t._)("code",null,"this.$options"),(0,t.Uk)("拿到")],-1),U=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"export"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"initState"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("vm"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Component")]),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"//这个数组将用来存储所有该组件实例的 watcher 对象"),(0,t.Uk)("\n  vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_watchers "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" opts "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$options\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("props"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"initProps"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("props"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("methods"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"initMethods"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("methods"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("data"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"initData"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 不存在则观测空对象"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"observe"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_data "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"true"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"/* asRootData */"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("computed"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"initComputed"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("computed"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("watch "),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(" opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("watch "),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(" nativeWatch"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"initWatch"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" opts"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("watch"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br")])],-1),b=(0,t._)("p",null,[(0,t.Uk)("我们主要看 "),(0,t._)("code",null,"initComputed"),(0,t.Uk)("是如何执行的。")],-1),m=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"initComputed"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("vm"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Component"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" computed"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Object")]),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// $flow-disable-line"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 创建原型为null的空对象 // 计算属性观察者列表"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" watchers "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_computedWatchers "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" Object"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"create"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"null"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// computed properties are just getters during SSR"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" isSSR "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"isServerRendering"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n   * computed: "),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        someComputedProp () "),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        return this.a + this.b\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n   */")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"for"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" key "),(0,t._)("span",{class:"token keyword"},"in"),(0,t.Uk)(" computed"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" userDef "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" computed"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 获取getter 对象写法和函数写法不同"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" getter "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" userDef "),(0,t._)("span",{class:"token operator"},"==="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'function'"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"?"),(0,t.Uk)(" userDef "),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" userDef"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("get\n    "),(0,t._)("span",{class:"token comment"},"// 计算属性没有对应的getter"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("process"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("env"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token constant"},"NODE_ENV"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'production'"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(" getter "),(0,t._)("span",{class:"token operator"},"=="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"null"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token function"},"warn"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token template-string"},[(0,t._)("span",{class:"token template-punctuation string"},"`"),(0,t._)("span",{class:"token string"},'Getter is missing for computed property "'),(0,t._)("span",{class:"token interpolation"},[(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"${"),(0,t.Uk)("key"),(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"}")]),(0,t._)("span",{class:"token string"},'".'),(0,t._)("span",{class:"token template-punctuation string"},"`")]),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n        vm\n      "),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("isSSR"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token comment"},"// create internal watcher for the computed property."),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token comment"},"// 计算属性的观察者对象"),(0,t.Uk)("\n      watchers"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Watcher"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n        vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n        getter "),(0,t._)("span",{class:"token operator"},"||"),(0,t.Uk)(" noop"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n        noop"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n        computedWatcherOptions\n      "),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n    "),(0,t._)("span",{class:"token comment"},"// component-defined computed properties are already defined on the"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// component prototype. We only need to define computed properties defined"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// at instantiation here."),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 计算属性的 key不能在 props data中存在，同名问题，因为他也会被放到 vm下"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key "),(0,t._)("span",{class:"token keyword"},"in"),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token function"},"defineComputed"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" key"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" userDef"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("process"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("env"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token constant"},"NODE_ENV"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'production'"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key "),(0,t._)("span",{class:"token keyword"},"in"),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$data"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token function"},"warn"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token template-string"},[(0,t._)("span",{class:"token template-punctuation string"},"`"),(0,t._)("span",{class:"token string"},'The computed property "'),(0,t._)("span",{class:"token interpolation"},[(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"${"),(0,t.Uk)("key"),(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"}")]),(0,t._)("span",{class:"token string"},'" is already defined in data.'),(0,t._)("span",{class:"token template-punctuation string"},"`")]),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("props "),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(" key "),(0,t._)("span",{class:"token keyword"},"in"),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("props"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token function"},"warn"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token template-string"},[(0,t._)("span",{class:"token template-punctuation string"},"`"),(0,t._)("span",{class:"token string"},'The computed property "'),(0,t._)("span",{class:"token interpolation"},[(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"${"),(0,t.Uk)("key"),(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"}")]),(0,t._)("span",{class:"token string"},'" is already defined as a prop.'),(0,t._)("span",{class:"token template-punctuation string"},"`")]),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("methods "),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(" key "),(0,t._)("span",{class:"token keyword"},"in"),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("methods"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token function"},"warn"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token template-string"},[(0,t._)("span",{class:"token template-punctuation string"},"`"),(0,t._)("span",{class:"token string"},'The computed property "'),(0,t._)("span",{class:"token interpolation"},[(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"${"),(0,t.Uk)("key"),(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"}")]),(0,t._)("span",{class:"token string"},'" is already defined as a method.'),(0,t._)("span",{class:"token template-punctuation string"},"`")]),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"23"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"24"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"25"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"26"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"27"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"28"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"29"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"30"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"31"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"32"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"33"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"34"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"35"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"36"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"37"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"38"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"39"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"40"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"41"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"42"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"43"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"44"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"45"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"46"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"47"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"48"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"49"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"50"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"51"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"52"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"53"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"54"),(0,t._)("br")])],-1),d=(0,t._)("p",null,"上面写的非常清楚，整个代码分为三块内容",-1),g=(0,t._)("ol",null,[(0,t._)("li",null,[(0,t.Uk)("创建一个"),(0,t._)("code",null,"watchers = vm._computedWatchers = null")]),(0,t._)("li",null,[(0,t.Uk)("拿到"),(0,t._)("code",null,"computed"),(0,t.Uk)("内的方法，赋值给"),(0,t._)("code",null,"getter"),(0,t.Uk)("，然后"),(0,t._)("code",null,"new Watcher"),(0,t.Uk)("，并赋值给"),(0,t._)("code",null,"watchers[key]")]),(0,t._)("li",null,[(0,t.Uk)("执行"),(0,t._)("code",null,"defineComputed"),(0,t.Uk)("方法，这里会判断"),(0,t._)("code",null,"computed"),(0,t.Uk)("的"),(0,t._)("code",null,"key"),(0,t.Uk)("在不在"),(0,t._)("code",null,"vm"),(0,t.Uk)("中，如果存在表示已定义会报错")])],-1),h=(0,t._)("p",null,"好了解了这三步，我们就可以按步骤分析，第一步先不说。直接看第二步",-1),y=(0,t._)("h3",{id:"创建一个计算属性watcher",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#创建一个计算属性watcher","aria-hidden":"true"},"#"),(0,t.Uk)(" 创建一个计算属性Watcher")],-1),w=(0,t._)("p",null,[(0,t._)("strong",null,"为什么叫计算属性watcher?")],-1),v=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t.Uk)("watchers"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Watcher"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n  vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  getter "),(0,t._)("span",{class:"token operator"},"||"),(0,t.Uk)(" noop"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  noop"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  computedWatcherOptions\n"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br")])],-1),f=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"export"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"default"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"class"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Watcher"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token function"},"constructor"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n    vm"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Component"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 求值表达式"),(0,t.Uk)("\n    expOrFn"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" string "),(0,t._)("span",{class:"token operator"},"|"),(0,t.Uk)(" Function"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 回调"),(0,t.Uk)("\n    cb"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Function"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 选项"),(0,t.Uk)("\n    options"),(0,t._)("span",{class:"token operator"},"?"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"?"),(0,t.Uk)("Object"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 是否是渲染watcher"),(0,t.Uk)("\n    isRenderWatcher"),(0,t._)("span",{class:"token operator"},"?"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" boolean\n  "),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// options"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("options"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("deep "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("deep "),(0,t._)("span",{class:"token comment"},"// 是否使用深度观测"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("user "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("user "),(0,t._)("span",{class:"token comment"},"// 用来标识当前观察者实例对象是 开发者定义的 还是 内部定义的"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("lazy "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("lazy "),(0,t._)("span",{class:"token comment"},"// 惰性watcher  第一次不请求"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("sync "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("sync "),(0,t._)("span",{class:"token comment"},"// 当数据变化的时候是否同步求值并执行回调"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("before "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("before "),(0,t._)("span",{class:"token comment"},"// 在触发更新之前的 调用回调"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("deep "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("user "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("lazy "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("sync "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"false"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("cb "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" cb "),(0,t._)("span",{class:"token comment"},"// 回调"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("id "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"++"),(0,t.Uk)("uid "),(0,t._)("span",{class:"token comment"},"// uid for batching 唯一标识"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("active "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"true"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 激活对象"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("dirty "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("lazy "),(0,t._)("span",{class:"token comment"},"// for lazy watchers"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 实现避免重复依赖"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("deps "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("newDeps "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("depIds "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Set"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("newDepIds "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Set"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// parse expression for getter"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" expOrFn "),(0,t._)("span",{class:"token operator"},"==="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'function'"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("getter "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" expOrFn\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token comment"},"// 处理表达式 obj.a"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("getter "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"parsePath"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("expOrFn"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("getter"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("getter "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" noop\n        "),(0,t._)("span",{class:"token comment"},"// Watcher 只接受简单的点(.)分隔路径，如果你要用全部的 js 语法特性直接观察一个函数即可"),(0,t.Uk)("\n        process"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("env"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token constant"},"NODE_ENV"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'production'"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"warn"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token template-string"},[(0,t._)("span",{class:"token template-punctuation string"},"`"),(0,t._)("span",{class:"token string"},'Failed watching path: "'),(0,t._)("span",{class:"token interpolation"},[(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"${"),(0,t.Uk)("expOrFn"),(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"}")]),(0,t._)("span",{class:"token string"},'" '),(0,t._)("span",{class:"token template-punctuation string"},"`")]),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"+"),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token string"},"'Watcher only accepts simple dot-delimited paths. '"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"+"),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token string"},"'For full control, use a function instead.'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n          vm\n        "),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 当时计算属性 构造函数是不求值的"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("value "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("lazy\n      "),(0,t._)("span",{class:"token operator"},"?"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"undefined"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"get"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"23"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"24"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"25"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"26"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"27"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"28"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"29"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"30"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"31"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"32"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"33"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"34"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"35"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"36"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"37"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"38"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"39"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"40"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"41"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"42"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"43"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"44"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"45"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"46"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"47"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"48"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"49"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"50"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"51"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"52"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"53"),(0,t._)("br")])],-1),j=(0,t._)("p",null,[(0,t.Uk)("在"),(0,t._)("code",null,"new Watcher"),(0,t.Uk)("的时候它传递了四个参数，首先看第四个参数，"),(0,t._)("code",null,"computedWatcherOptions"),(0,t.Uk)("，它是一个"),(0,t._)("code",null,"options"),(0,t.Uk)("。我们看看这个东西是什么")],-1),x=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" computedWatcherOptions "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" lazy"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"true"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br")])],-1),D=(0,t._)("p",null,[(0,t.Uk)("将"),(0,t._)("code",null,"lazy"),(0,t.Uk)("赋值给"),(0,t._)("code",null,"true"),(0,t.Uk)("，然后在"),(0,t._)("code",null,"watcher"),(0,t.Uk)("构造函数中将"),(0,t._)("code",null,"this.dirty = this.lazy = true"),(0,t.Uk)("。它和在"),(0,t._)("code",null,"mountComponent"),(0,t.Uk)("定义的"),(0,t._)("code",null,"Wacher"),(0,t.Uk)("不同 具备不同的属性，所以用他的"),(0,t._)("code",null,"options"),(0,t.Uk)("命名，计算"),(0,t._)("code",null,"Wacher"),(0,t.Uk)("。")],-1),W=(0,t._)("p",null,[(0,t._)("strong",null,"注意"),(0,t.Uk)(" 我们可以看到，正因为他是"),(0,t._)("code",null,"lazy = true"),(0,t.Uk)("，所以首次执行，他不会进行求值，也就是不会执行。"),(0,t._)("code",null,"this.get()"),(0,t.Uk)("。即它自身，也就是我们例子的"),(0,t._)("code",null,"comp"),(0,t.Uk)("不参与"),(0,t._)("code",null,"watcher"),(0,t.Uk)("的求值。 留意一下"),(0,t._)("strong",null,"思考为什么要这么做"),(0,t.Uk)("。")],-1),C=(0,t._)("h2",{id:"definecomputed",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#definecomputed","aria-hidden":"true"},"#"),(0,t.Uk)(" defineComputed")],-1),S=(0,t._)("p",null,[(0,t.Uk)("好我们看下一个方法"),(0,t._)("code",null,"defineComputed(vm, key, userDef)"),(0,t.Uk)("，从方法名就能很清楚的知道，这个方法用来定义拦截器")],-1),$=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"export"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"defineComputed"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("target"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" any"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  key"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" string"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  userDef"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Object "),(0,t._)("span",{class:"token operator"},"|"),(0,t.Uk)(" Function")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 非服务端下计算属性杯缓存"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" shouldCache "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token function"},"isServerRendering"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" userDef "),(0,t._)("span",{class:"token operator"},"==="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'function'"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 浏览器端和服务端处理不同"),(0,t.Uk)("\n    sharedPropertyDefinition"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("get "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" shouldCache\n      "),(0,t._)("span",{class:"token operator"},"?"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"createComputedGetter"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"createGetterInvoker"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("userDef"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    sharedPropertyDefinition"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("set "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" noop\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    sharedPropertyDefinition"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("get "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" userDef"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("get\n      "),(0,t._)("span",{class:"token operator"},"?"),(0,t.Uk)(" shouldCache "),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(" userDef"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("cache "),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"false"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token operator"},"?"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"createComputedGetter"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"createGetterInvoker"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("userDef"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("get"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" noop\n    sharedPropertyDefinition"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("set "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" userDef"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("set "),(0,t._)("span",{class:"token operator"},"||"),(0,t.Uk)(" noop\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 当计算属性没有设置set就不能为computed 赋值"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("process"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("env"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token constant"},"NODE_ENV"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'production'"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)("\n      sharedPropertyDefinition"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("set "),(0,t._)("span",{class:"token operator"},"==="),(0,t.Uk)(" noop"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    sharedPropertyDefinition"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function-variable function"},"set"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token function"},"warn"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token template-string"},[(0,t._)("span",{class:"token template-punctuation string"},"`"),(0,t._)("span",{class:"token string"},'Computed property "'),(0,t._)("span",{class:"token interpolation"},[(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"${"),(0,t.Uk)("key"),(0,t._)("span",{class:"token interpolation-punctuation punctuation"},"}")]),(0,t._)("span",{class:"token string"},'" was assigned to but it has no setter.'),(0,t._)("span",{class:"token template-punctuation string"},"`")]),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token keyword"},"this"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  Object"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"defineProperty"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" key"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" sharedPropertyDefinition"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"23"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"24"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"25"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"26"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"27"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"28"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"29"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"30"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"31"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"32"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"33"),(0,t._)("br")])],-1),E=(0,t._)("p",null,[(0,t.Uk)("这里我们只要看"),(0,t._)("code",null,"sharedPropertyDefinition"),(0,t.Uk)("用的是什么"),(0,t._)("code",null,"get"),(0,t.Uk)("和"),(0,t._)("code",null,"set"),(0,t.Uk)("就可以了。")],-1),O=(0,t._)("ol",null,[(0,t._)("li",null,[(0,t.Uk)("当"),(0,t._)("code",null,"userDef"),(0,t.Uk)("是一个方法时，在非服务端渲染环境下使用"),(0,t._)("code",null,"createComputedGetter(userDef)"),(0,t.Uk)("，并且"),(0,t._)("code",null,"set"),(0,t.Uk)("是一个空函数")]),(0,t._)("li",null,[(0,t.Uk)("当"),(0,t._)("code",null,"userDef"),(0,t.Uk)("是一个对象时，使用"),(0,t._)("code",null,"createComputedGetter(userDef.get)"),(0,t.Uk)("，而"),(0,t._)("code",null,"set"),(0,t.Uk)("会执行赋值")])],-1),q=(0,t._)("p",null,[(0,t.Uk)("我们看看"),(0,t._)("code",null,"createComputedGetter"),(0,t.Uk)("方法做了什么")],-1),A=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"createComputedGetter"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},"key"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 计算属性拦截器"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"computedGetter"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" watcher "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_computedWatchers "),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_computedWatchers"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("watcher"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token comment"},"// dirty = lazy = true"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token comment"},"// 执行了 this.get 对 计算属性里的方法的data值做了一次依赖"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token comment"},"// 求值运算 计算watcher"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("dirty"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"evaluate"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token comment"},"// 渲染watcher"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("Dep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"depend"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(" watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("value\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br")])],-1),F=(0,t._)("p",null,[(0,t.Uk)("执行了"),(0,t._)("code",null,"createComputedGetter(key)"),(0,t.Uk)("方法，然后返回了"),(0,t._)("code",null,"computedGetter"),(0,t.Uk)("，我们定义的"),(0,t._)("code",null,"get"),(0,t.Uk)("是"),(0,t._)("code",null,"computedGetter"),(0,t.Uk)("方法，并且使用闭包，缓存了起来。 根据例子"),(0,t._)("code",null,"defineComputed"),(0,t.Uk)("执行后的效果是")],-1),z=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t.Uk)("Object"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"defineProperty"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'compA'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  configurable"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"true"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  enumerable"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"true"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  get"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"computedGetter"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token function-variable function"},"set"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br")])],-1),T=(0,t._)("p",null,[(0,t.Uk)("我们在实例上，创建了一个对"),(0,t._)("code",null,"compA"),(0,t.Uk)("的拦截器。这样"),(0,t._)("code",null,"initComputed"),(0,t.Uk)("就结束了。")],-1),P=(0,t._)("h2",{id:"生成执行执行函数",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#生成执行执行函数","aria-hidden":"true"},"#"),(0,t.Uk)(" 生成执行执行函数")],-1),V=(0,t._)("p",null,[(0,t.Uk)("这里我们不详细讨论了，因为这块要讲清楚非常长，简要流程就是，运行到渲染"),(0,t._)("code",null,"Wacher"),(0,t.Uk)("的创建的时候")],-1),R=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"export"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"mountComponent"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("vm"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Component"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  el"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"?"),(0,t.Uk)("Element"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  hydrating"),(0,t._)("span",{class:"token operator"},"?"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" boolean")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Component "),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token operator"},"..."),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function-variable function"},"updateComponent"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n       vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"_update"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"_render"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" hydrating"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n     "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     "),(0,t._)("span",{class:"token operator"},"..."),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Watcher"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" updateComponent"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" noop"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n     "),(0,t._)("span",{class:"token function"},"before"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n       "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_isMounted "),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_isDestroyed"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n         "),(0,t._)("span",{class:"token function"},"callHook"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'beforeUpdate'"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n       "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"true"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"/* isRenderWatcher */"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(" vm\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br")])],-1),G=(0,t._)("p",null,[(0,t.Uk)("这里"),(0,t._)("code",null,"lazy"),(0,t.Uk)("为"),(0,t._)("code",null,"false"),(0,t.Uk)("，所以构造函数初始化完成最后会执行"),(0,t._)("code",null,"this.get()")],-1),N=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token function"},"get"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token operator"},"..."),(0,t.Uk)(" \n value "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"getter"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"call"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token operator"},"..."),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(" value\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br")])],-1),I=(0,t._)("p",null,[(0,t.Uk)("不看其他代码，核心就是执行了"),(0,t._)("code",null,"this.getter"),(0,t.Uk)("，这个在构造函数中有赋值，就是"),(0,t._)("code",null,"updateComponent"),(0,t.Uk)("。 所以我们执行了"),(0,t._)("code",null,"vm._update(vm._render(), hydrating)"),(0,t.Uk)("。首先看"),(0,t._)("code",null,"vm._render"),(0,t.Uk)("方法，它定义在"),(0,t._)("code",null,"render.js"),(0,t.Uk)("中。 现在它的关键就两行代码。")],-1),H=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token class-name"},"Vue"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("prototype"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function-variable function"},"_render"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" VNode "),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Component "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 通过规整化好后的 $options拿到 渲染函数"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" render"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" _parentVnode "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$options\n \n  "),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" vnode\n  "),(0,t._)("span",{class:"token comment"},"// 执行render.call(vm, 拿到用户输入或者编译生成的createElement函数)"),(0,t.Uk)("\n  vnode "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"render"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"call"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_renderProxy"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$createElement"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    \n  "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(" vnode\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br")])],-1),M=(0,t._)("ol",null,[(0,t._)("li",null,[(0,t.Uk)("从 "),(0,t._)("code",null,"vm.$options"),(0,t.Uk)(" 中获取 "),(0,t._)("code",null,"render"),(0,t.Uk)("。")]),(0,t._)("li",null,[(0,t.Uk)("执行"),(0,t._)("code",null,"render"),(0,t.Uk)("方法。并传入当前实例，和"),(0,t._)("code",null,"vm.$createElement"),(0,t.Uk)("，"),(0,t._)("code",null,"vm.$createElement"),(0,t.Uk)("是"),(0,t._)("code",null,"initRender"),(0,t.Uk)("时候定义的"),(0,t._)("code",null,"createElement")])],-1),Y=(0,t._)("p",null,[(0,t.Uk)("我们先来看看"),(0,t._)("code",null,"render"),(0,t.Uk)("是什么，这个要去"),(0,t._)("code",null,"platforms/web/entry-runtime-with-compiler"),(0,t.Uk)("下看。这是一个和环境相关的值")],-1),X=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token comment"},"// 缓存 runtime/index.js 中的 $mount 方法"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" mount "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Vue"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("prototype"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$mount\n"),(0,t._)("span",{class:"token comment"},"// 重写 Vue.prototype.$mount 方法"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token class-name"},"Vue"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("prototype"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function-variable function"},"$mount"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("el"),(0,t._)("span",{class:"token operator"},"?"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" string "),(0,t._)("span",{class:"token operator"},"|"),(0,t.Uk)(" Element"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  hydrating"),(0,t._)("span",{class:"token operator"},"?"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" boolean")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Component "),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 获取挂载点的dom"),(0,t.Uk)("\n  el "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" el "),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"query"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("el"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" options "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("$options\n  "),(0,t._)("span",{class:"token comment"},"// resolve template/el and convert to render function"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 使用 template 或 el 选项构建渲染函数"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("render"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" template "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("template\n    "),(0,t._)("span",{class:"token operator"},"..."),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 获取template的html， el得到的html会赋值给template"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 可能存在template为空 拿到的数据为空"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("template"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token comment"},"// 通过compileToFunction 生成 render 和 静态render"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" render"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" staticRenderFns "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"compileToFunctions"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("template"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        outputSourceRange"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" process"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("env"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token constant"},"NODE_ENV"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'production'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token comment"},"// 在模板编译的时候对属性的换行符做处理"),(0,t.Uk)("\n        shouldDecodeNewlines"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n        shouldDecodeNewlinesForHref"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n        delimiters"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("delimiters"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n        comments"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("comments\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("render "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" render\n      options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("staticRenderFns "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" staticRenderFns\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 调用mount"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"mount"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"call"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" el"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" hydrating"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"23"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"24"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"25"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"26"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"27"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"28"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"29"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"30"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"31"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"32"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"33"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"34"),(0,t._)("br")])],-1),Z=(0,t._)("p",null,[(0,t.Uk)("这里我们拿到了"),(0,t._)("code",null,"render"),(0,t.Uk)("，并赋值给了"),(0,t._)("code",null,"this.$options"),(0,t.Uk)("。所以上面我们才可以拿到，我们再进去看"),(0,t._)("code",null,"compileToFunctions"),(0,t.Uk)("，层层向上找，我们来到了")],-1),Q=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"export"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" createCompiler "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"createCompilerCreator"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"baseCompile"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("template"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" string"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  options"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" CompilerOptions")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" CompiledResult "),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 解析原始代码并生成AST"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" ast "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"parse"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("template"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"trim"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" options"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("options"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("optimize "),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"false"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 将ast中的不变代码 标识static"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"optimize"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("ast"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" options"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 根据给定的AST生成目标平台的代码"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" code "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"generate"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("ast"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" options"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    ast"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    render"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" code"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("render"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    staticRenderFns"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" code"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("staticRenderFns\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br")])],-1),B=(0,t._)("p",null,[(0,t.Uk)("这里是解析"),(0,t._)("code",null,"html"),(0,t.Uk)("的核心，里面"),(0,t._)("code",null,"vue"),(0,t.Uk)("运用了函数柯里化的方法将解析和一些错误判断进行了隔离，我们在"),(0,t._)("code",null,"code"),(0,t.Uk)("之后打个"),(0,t._)("code",null,"debugger"),(0,t.Uk)("。直接看"),(0,t._)("code",null,"template"),(0,t.Uk)("的最终生成")],-1),J=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"with"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"_c"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"'div'"),(0,t._)("span",{class:"token punctuation"},","),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("attrs"),(0,t._)("span",{class:"token operator"},":"),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)('\\"id\\"'),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)('\\"app\\"'),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token function"},"_c"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"'div'"),(0,t._)("span",{class:"token punctuation"},","),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token function"},"_v"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token function"},"_s"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("compA"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br")])],-1),K=(0,t._)("p",null,[(0,t.Uk)("这是我们例子的代码"),(0,t._)("code",null,"code"),(0,t.Uk)("字符串，之后通过"),(0,t._)("code",null,"new Function(code)"),(0,t.Uk)("就拿到了一个匿名函数")],-1),L=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token punctuation"},";"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"anonymous"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"with"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"_c"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"'div'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" attrs"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" id"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'app'"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token function"},"_c"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"'div'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token function"},"_v"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token function"},"_s"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("compA"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br")])],-1),nn=(0,t._)("h2",{id:"执行匿名函数",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#执行匿名函数","aria-hidden":"true"},"#"),(0,t.Uk)(" 执行匿名函数")],-1),sn=(0,t._)("p",null,[(0,t.Uk)("这里注意一下，在开发环境"),(0,t._)("code",null,"vm._renderProxy"),(0,t.Uk)("是一个"),(0,t._)("code",null,"proxy"),(0,t.Uk)("代理，或者"),(0,t._)("code",null,"vm"),(0,t.Uk)("。在正式环境它就是"),(0,t._)("code",null,"vm"),(0,t.Uk)("。")],-1),an=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token comment"},"// Vue.prototype._init方法中"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token comment"},"/* istanbul ignore else */"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("process"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("env"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token constant"},"NODE_ENV"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'production'"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 设置渲染函数的作用域代理，其目的是为我们提供更好的提示信息"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token function"},"initProxy"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 在生产环境中通过，vue-loader 编译后的template 是不 使用 with 语句包裹的 js代码，"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 所以不需要proxy 的has 去代理 with中的 属性"),(0,t.Uk)("\n   vm"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_renderProxy "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" vm\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br")])],-1),tn=(0,t._)("p",null,[(0,t.Uk)("好那么现在我们开始执行，首先我们先来了解一下"),(0,t._)("code",null,"_c、_v、_s"),(0,t.Uk)("分别是什么。"),(0,t._)("code",null,"_c"),(0,t.Uk)("我们可以在"),(0,t._)("code",null,"initRender"),(0,t.Uk)("中看到，它就是"),(0,t._)("code",null,"createElement"),(0,t.Uk)("返回一个Vnode。 其他我们可以在"),(0,t._)("code",null,"instance/render-helpers/index.js"),(0,t.Uk)("中看到。")],-1),en=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token comment"},"// 返回Vnode"),(0,t.Uk)("\n_c "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"createElement"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vm"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" a"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" b"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" c"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" d"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"false"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token comment"},"// 创建一个空节点"),(0,t.Uk)("\n_v "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" createTextVNode\n"),(0,t._)("span",{class:"token comment"},"// 转为字符串"),(0,t.Uk)("\n_s "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" toString\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br")])],-1),on=(0,t._)("p",null,[(0,t.Uk)("我们主要看 "),(0,t._)("code",null,"toString"),(0,t.Uk)("的执行中"),(0,t._)("code",null,"compA"),(0,t.Uk)("的执行，也就是我们运行了"),(0,t._)("code",null,"this['compA']"),(0,t.Uk)("。因为上面定义了拦截器，所以我们会执行到"),(0,t._)("code",null,"computedGetter"),(0,t.Uk)("。")],-1),cn=(0,t._)("h2",{id:"开始真正的computed执行",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#开始真正的computed执行","aria-hidden":"true"},"#"),(0,t.Uk)(" 开始真正的computed执行")],-1),pn=(0,t._)("h3",{id:"执行-watcher-evaluate",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#执行-watcher-evaluate","aria-hidden":"true"},"#"),(0,t.Uk)(" 执行 watcher.evaluate()")],-1),ln=(0,t._)("p",null,[(0,t.Uk)("因为我们缓存了之前的"),(0,t._)("code",null,"key"),(0,t.Uk)("，所以们在当前实例下面，拿到了之前"),(0,t._)("code",null,"new"),(0,t.Uk)("的计算"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("。第一次，我们执行"),(0,t._)("code",null,"watcher.evaluate()"),(0,t.Uk)("注意这时候的"),(0,t._)("code",null,"watcher"),(0,t.Uk)("是计算"),(0,t._)("code",null,"watcher"),(0,t.Uk)("。")],-1),kn=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"computedGetter"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" watcher "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_computedWatchers "),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("_computedWatchers"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("watcher"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// dirty = lazy = true"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 执行了 this.get 对 计算属性里的方法的data值做了一次依赖"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("dirty"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n     watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"evaluate"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("Dep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n     watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"depend"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(" watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("value\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br")])],-1),un=(0,t._)("p",null,[(0,t.Uk)("这时候我们执行了"),(0,t._)("code",null,"this.get()"),(0,t.Uk)("。从上面分析可知，执行"),(0,t._)("code",null,"this.get()"),(0,t.Uk)("就是执行"),(0,t._)("code",null,"this.getter"),(0,t.Uk)("，也就是初始化传入的求值表达式，"),(0,t._)("code",null,"computed"),(0,t.Uk)("的求值表达式是")],-1),_n=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token function"},"evaluate"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("value "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"get"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("dirty "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"false"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br")])],-1),rn=(0,t._)("p",null,[(0,t.Uk)("可以清晰的看到，这时候我们触发了"),(0,t._)("code",null,"this.a"),(0,t.Uk)("。根据响应式原理，这里我们将触发"),(0,t._)("code",null,"data"),(0,t.Uk)("中早已定义好的拦截器"),(0,t._)("code",null,"get"),(0,t.Uk)("。进行响应式依赖的收集，将我们的计算"),(0,t._)("code",null,"Watcher"),(0,t.Uk)(", 放到了"),(0,t._)("code",null,"dep.subs"),(0,t.Uk)("中。 这里我不详细说明"),(0,t._)("code",null,"data"),(0,t.Uk)("的响应式收集过程了。等下一篇文章关于"),(0,t._)("code",null,"data"),(0,t.Uk)("再分析。我们只要知道"),(0,t._)("code",null,"a"),(0,t.Uk)("的"),(0,t._)("code",null,"dep"),(0,t.Uk)("数组中存放了计算"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("。然后把 "),(0,t._)("code",null,"dirty = false"),(0,t.Uk)("。"),(0,t._)("code",null,"watcher.evaluate()"),(0,t.Uk)("执行完成。")],-1),Un=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("a "),(0,t._)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t._)("span",{class:"token number"},"1"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br")])],-1),bn=(0,t._)("h3",{id:"执行-watcher-depend",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#执行-watcher-depend","aria-hidden":"true"},"#"),(0,t.Uk)(" 执行 watcher.depend()")],-1),mn=(0,t._)("p",null,[(0,t.Uk)("执行"),(0,t._)("code",null,"watcher.depend()"),(0,t.Uk)("之前，我们想一想"),(0,t._)("code",null,"Dep.target"),(0,t.Uk)("是什么？")],-1),dn=(0,t._)("p",null,[(0,t.Uk)("首先我们要明确一点，它是一个全局属性，在初始化中指向当前"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("。"),(0,t._)("strong",null,[(0,t.Uk)("现在我们执行的是整个"),(0,t._)("code",null,"vue"),(0,t.Uk)("的初始化，它有且仅有一个"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("，渲染"),(0,t._)("code",null,"Watcher")])],-1),gn=(0,t._)("p",null,[(0,t._)("strong",null,[(0,t.Uk)("那为什么他会变成当前的渲染"),(0,t._)("code",null,"watcher"),(0,t.Uk)("？")]),(0,t.Uk)(" 这里我们要回过头来看看，上面执行的"),(0,t._)("code",null,"this.get()"),(0,t.Uk)("。看代码")],-1),hn=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token function"},"get"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 给Dep.target 赋值 Watcher"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token function"},"pushTarget"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token comment"},"// 清除当前 target"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token function"},"popTarget"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n \n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(" value\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token comment"},"// observer/dep.js"),(0,t.Uk)("\nDep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("target "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"null"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" targetStack "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n\n"),(0,t._)("span",{class:"token keyword"},"export"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"pushTarget"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("target"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"?"),(0,t.Uk)("Watcher")]),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  targetStack"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"push"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  Dep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("target "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" target\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n"),(0,t._)("span",{class:"token keyword"},"export"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"popTarget"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  targetStack"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"pop"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  Dep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("target "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" targetStack"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("targetStack"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length "),(0,t._)("span",{class:"token operator"},"-"),(0,t.Uk)(),(0,t._)("span",{class:"token number"},"1"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"23"),(0,t._)("br")])],-1),yn=(0,t._)("p",null,[(0,t.Uk)("首先我们全局维护了"),(0,t._)("code",null,"targetStack"),(0,t.Uk)("和"),(0,t._)("code",null,"Dep.target"),(0,t.Uk)("。在我们初始化"),(0,t._)("code",null,"vue"),(0,t.Uk)("如果不存在"),(0,t._)("code",null,"computed"),(0,t.Uk)("，我们的"),(0,t._)("code",null,"Dep.target"),(0,t.Uk)("就指向渲染"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("。"),(0,t._)("code",null,"targetStack"),(0,t.Uk)("也保存着它。 但是在执行"),(0,t._)("code",null,"watcher.evaluate()"),(0,t.Uk)("的时候，我们用的是保存在"),(0,t._)("code",null,"this._computedWatchers"),(0,t.Uk)("中的计算"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("。这时候通过第一个方法，我们"),(0,t._)("code",null,"push"),(0,t.Uk)("到了"),(0,t._)("code",null,"targetStack"),(0,t.Uk)("，但是在求值完成之后， 我们"),(0,t._)("code",null,"popTarget"),(0,t.Uk)("了当前的"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("。这时候，当前的"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("就变成了渲染"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("。")],-1),wn=(0,t._)("p",null,[(0,t.Uk)("好明白这一点，我们执行"),(0,t._)("code",null,"watcher.depend()"),(0,t.Uk)("。")],-1),vn=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token function"},"depend"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" i "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("deps"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length\n "),(0,t._)("span",{class:"token keyword"},"while"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("i"),(0,t._)("span",{class:"token operator"},"--"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("deps"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("i"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"depend"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br")])],-1),fn=(0,t._)("p",null,[(0,t.Uk)("这个"),(0,t._)("code",null,"this.deps"),(0,t.Uk)("我们保存着计算"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("。它的长度为1，好我们再次执行了依赖收集，但是当前"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("是渲染"),(0,t._)("code",null,"watcher"),(0,t.Uk)("。这个上面已经分析过了，在执行完成依赖收集之后我们可以看到 当前的"),(0,t._)("code",null,"a"),(0,t.Uk)("中的"),(0,t._)("code",null,"Dep"),(0,t.Uk)("实例下的"),(0,t._)("code",null,"subs"),(0,t.Uk)("数组中保存了两个"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("。")],-1),jn=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  id"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token number"},"3"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n  subs"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("\n    Watcher"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 计算 Watcher"),(0,t.Uk)("\n    Watcher "),(0,t._)("span",{class:"token comment"},"// 渲染 Watcher"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br")])],-1),xn=(0,t._)("p",null,[(0,t.Uk)("之后我们返回了"),(0,t._)("code",null,"watcher.value"),(0,t.Uk)("，也就是计算"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("求值之后的值，之后就是"),(0,t._)("code",null,"vm._update"),(0,t.Uk)("的执行，将"),(0,t._)("code",null,"vnode"),(0,t.Uk)("渲染到页面上。首次渲染完成")],-1),Dn=(0,t._)("h2",{id:"来思考一些问题",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#来思考一些问题","aria-hidden":"true"},"#"),(0,t.Uk)(" 来思考一些问题")],-1),Wn=(0,t._)("ol",null,[(0,t._)("li",null,"基于响应式的缓存是如何实现的")],-1),Cn=(0,t._)("p",null,"我们看一个例子",-1),Sn=(0,t._)("div",{class:"language-html ext-html line-numbers-mode"},[(0,t._)("pre",{class:"language-html"},[(0,t._)("code",null,[(0,t._)("span",{class:"token doctype"},[(0,t._)("span",{class:"token punctuation"},"<!"),(0,t._)("span",{class:"token doctype-tag"},"DOCTYPE"),(0,t.Uk)(),(0,t._)("span",{class:"token name"},"html"),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("html")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"lang"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("en"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("head")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("meta")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"charset"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("UTF-8"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("meta")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"http-equiv"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("X-UA-Compatible"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"content"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("IE=edge"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("meta")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"name"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("viewport"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"content"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("width=device-width, initial-scale=1.0"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("title")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("computed"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("title")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("script")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"src"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("../../dist/vue.js"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t._)("span",{class:"token script"}),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("script")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("head")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("body")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("div")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"id"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("app"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("div")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("{{compA}}"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("div")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("div")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("{{compA}}"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("div")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("div")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("script")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t._)("span",{class:"token script"},[(0,t._)("span",{class:"token language-javascript"},[(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" vm "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Vue"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      el"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'#app'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n      data"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        a"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token number"},"1"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n      computed"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token function"},"compA"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("a "),(0,t._)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t._)("span",{class:"token number"},"1"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  ")])]),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("script")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("body")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n"),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("html")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"highlight-lines"},[(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("div",{class:"highlight-line"}," "),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br")]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"23"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"24"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"25"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"26"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"27"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"28"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"29"),(0,t._)("br")])],-1),$n=(0,t._)("p",null,[(0,t.Uk)("对我们再次放了一个"),(0,t._)("code",null,"compA"),(0,t.Uk)("上去，第二次执行"),(0,t._)("code",null,"this['compA']"),(0,t.Uk)("有什么不同?")],-1),En=(0,t._)("p",null,[(0,t.Uk)("首先我们清楚一点在计算"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("中，我们定义了两个属性"),(0,t._)("code",null,"dirty=lazy=true"),(0,t.Uk)("。但是在第一次求值过程中我们将"),(0,t._)("code",null,"dirty"),(0,t.Uk)("赋值为了"),(0,t._)("code",null,"false"),(0,t.Uk)("。")],-1),On=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token function"},"evaluate"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("value "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"get"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("dirty "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"false"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("dirty"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  watcher"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"evaluate"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br")])],-1),qn=(0,t._)("p",null,[(0,t.Uk)("因此我们在第二次执行的时候，"),(0,t._)("code",null,"watcher.dirty"),(0,t.Uk)("为"),(0,t._)("code",null,"false"),(0,t.Uk)("，所以他不会执行。这就是闭包的好处。而执行"),(0,t._)("code",null,"watcher.depend"),(0,t.Uk)("的是时候，它的重复收集和"),(0,t._)("code",null,"addDep"),(0,t.Uk)("方法相关")],-1),An=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token function"},"addDep"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("dep"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Dep")]),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" id "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" dep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("id\n "),(0,t._)("span",{class:"token comment"},"// * 在一次求值中 查看这个唯一id 是否在set中已存在，"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("newDepIds"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"has"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("id"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br")])],-1),Fn=(0,t._)("p",null,[(0,t.Uk)("这里会判断"),(0,t._)("code",null,"this.newDepIds"),(0,t.Uk)("中是否存在当前的依赖"),(0,t._)("code",null,"id"),(0,t.Uk)("，同一个显然是相当的，所以直接返回。这就是缓存的实现。关于这块的去重问题，等之后响应式"),(0,t._)("code",null,"data"),(0,t.Uk)("的解析吧。")],-1),zn=(0,t._)("h2",{id:"更新数据",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#更新数据","aria-hidden":"true"},"#"),(0,t.Uk)(" 更新数据")],-1),Tn=(0,t._)("p",null,[(0,t._)("strong",null,"只在相关响应式依赖发生改变时它们才会重新求值")],-1),Pn=(0,t._)("p",null,[(0,t.Uk)("好明白这个，我们再来看后半句，我们试着更新一下"),(0,t._)("code",null,"a"),(0,t.Uk)("的值，看看发生什么，在"),(0,t._)("code",null,"console"),(0,t.Uk)("中执行"),(0,t._)("code",null,"vm.a = 3"),(0,t.Uk)("。 这时候我们触发了"),(0,t._)("code",null,"data"),(0,t.Uk)("拦截器中"),(0,t._)("code",null,"set"),(0,t.Uk)("函数的"),(0,t._)("code",null,"dep.notify()"),(0,t.Uk)("方法。")],-1),Vn=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token function"},"notify"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token comment"},"// stabilize the subscriber list first"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" subs "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("subs"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"slice"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"for"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" i "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token number"},"0"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" l "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" subs"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)(" i "),(0,t._)("span",{class:"token operator"},"<"),(0,t.Uk)(" l"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)(" i"),(0,t._)("span",{class:"token operator"},"++"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 循环执行所有的 观察者对象"),(0,t.Uk)("\n   subs"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("i"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"update"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br")])],-1),Rn=(0,t._)("p",null,[(0,t.Uk)("从上面可以看出，我们顺序执行"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("的"),(0,t._)("code",null,"update"),(0,t.Uk)("方法。来看看"),(0,t._)("code",null,"update"),(0,t.Uk)("方法的实现")],-1),Gn=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token function"},"update"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token comment"},"// 计算属性值是不参与更新的"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("lazy"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("dirty "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"true"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 是否同步更新变化"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("sync"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"run"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 将当前观察者对象放到一个异步更新队列"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token function"},"queueWatcher"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"highlight-lines"},[(0,t._)("br"),(0,t._)("br"),(0,t._)("div",{class:"highlight-line"}," "),(0,t._)("div",{class:"highlight-line"}," "),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br")]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br")])],-1),Nn=(0,t._)("p",null,[(0,t.Uk)("从上面我们知道，第一个"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("是计算"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("，所以它的"),(0,t._)("code",null,"lazy"),(0,t.Uk)("是"),(0,t._)("code",null,"true"),(0,t.Uk)("，在这个代码段中，只执行了 "),(0,t._)("code",null,"this.dirty=true"),(0,t.Uk)("，"),(0,t._)("strong",null,[(0,t.Uk)("为什么要执行这一步，结合第一次赋值为"),(0,t._)("code",null,"false"),(0,t.Uk)("想一想")]),(0,t.Uk)("。好我这里先卖个关子。")],-1),In=(0,t._)("p",null,[(0,t.Uk)("然后我们看第二个渲染"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("的执行，这时候"),(0,t._)("code",null,"lazy"),(0,t.Uk)("不为"),(0,t._)("code",null,"true"),(0,t.Uk)("了，我们执行到了"),(0,t._)("code",null,"queueWatcher"),(0,t.Uk)("。在这个方法中，首先存了一个"),(0,t._)("code",null,"watcher"),(0,t.Uk)("队列，并且把队列放到了"),(0,t._)("code",null,"nextTick"),(0,t.Uk)("中执行，也就是放到了下一次事件循环之前的 微任务中，然后在"),(0,t._)("code",null,"flushSchedulerQueue"),(0,t.Uk)("方法中会执行到"),(0,t._)("code",null,"watcher.run"),(0,t.Uk)("，之后进行再次求值。更新值，更新 "),(0,t._)("code",null,"DOM")],-1),Hn=(0,t._)("p",null,[(0,t.Uk)("上面内容不细说，等到分析"),(0,t._)("code",null,"nextTick"),(0,t.Uk)("再看。")],-1),Mn=(0,t._)("p",null,"我们先来看上面的问题",-1),Yn=(0,t._)("p",null,[(0,t.Uk)("为什么要给"),(0,t._)("code",null,"this.dirty"),(0,t.Uk)("赋值为"),(0,t._)("code",null,"true"),(0,t.Uk)("?")],-1),Xn=(0,t._)("p",null,"要解答这个问题，我们先来看最新的例子的匿名执行代码",-1),Zn=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token punctuation"},";"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"anonymous"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"with"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"_c"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"'div'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" attrs"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" id"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token string"},"'app'"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token function"},"_c"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"'div'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token function"},"_v"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token function"},"_s"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("compA"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token function"},"_v"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"' '"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token function"},"_c"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"'div'"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t._)("span",{class:"token function"},"_v"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token function"},"_s"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("compA"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br")])],-1),Qn=(0,t._)("p",null,[(0,t.Uk)("可以发现我们执行了两次"),(0,t._)("code",null,"this['compA']"),(0,t.Uk)("，那么整体流程就显而易见了")],-1),Bn=(0,t._)("p",null,[(0,t.Uk)("第一次执行"),(0,t._)("code",null,"this['compA']"),(0,t._)("code",null,"dep.notify--\x3edep.update--\x3equeueWatcher--\x3ewatcher.run--\x3ethis.getter"),(0,t.Uk)("。 上面在第一个计算"),(0,t._)("code",null,"Watcher"),(0,t.Uk)("中我们赋值了"),(0,t._)("code",null,"this.dirty = true"),(0,t.Uk)("。然后执行了渲染函数中的"),(0,t._)("code",null,"vm._update(vm._render)"),(0,t.Uk)("。也就是执行上面的匿名函数")],-1),Jn=(0,t._)("p",null,[(0,t.Uk)("这时候会触发"),(0,t._)("code",null,"computedGetter"),(0,t.Uk)("，但是我们的"),(0,t._)("code",null,"dirty"),(0,t.Uk)("为"),(0,t._)("code",null,"true"),(0,t.Uk)("，所以首次我们会对计算属性进行重新求值。但是这时候我们也重新进行了依赖添加呀？观察以下代码")],-1),Kn=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token function"},"addDep"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("dep"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(" Dep")]),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" id "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" dep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("id\n "),(0,t._)("span",{class:"token comment"},"// * 在一次求值中 查看这个唯一id 是否在set中已存在，"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("newDepIds"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"has"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("id"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 不存在就放进 set里面 然后吧 dep也放到 newdeps里"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 每次重新求值， newDepIds 都会被清空"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("newDepIds"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"add"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("id"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("newDeps"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"push"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("dep"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// * 在 多次求值 中避免收集重复依赖的"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("depIds"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"has"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("id"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n     dep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"addSub"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br")])],-1),Ln=(0,t._)("p",null,[(0,t._)("code",null,"depIds"),(0,t.Uk)("保存的是上一次的依赖，每一个"),(0,t._)("code",null,"Dep"),(0,t.Uk)("都会存有一个唯一的"),(0,t._)("code",null,"id"),(0,t.Uk)("，计算的值没变，所以上一次和这一次是一致的。依赖不会保存。这里仍旧和"),(0,t._)("code",null,"data"),(0,t.Uk)("的初始化相关。")],-1),ns=(0,t._)("p",null,[(0,t.Uk)("然后第二个"),(0,t._)("code",null,"this['compA']"),(0,t.Uk)("进来就和初始化一样了。")],-1),ss=(0,t._)("h2",{id:"总结",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#总结","aria-hidden":"true"},"#"),(0,t.Uk)(" 总结")],-1),as=(0,t._)("p",null,[(0,t.Uk)("这样我们就彻底解析了"),(0,t._)("code",null,"computed"),(0,t.Uk)("的核心实现，也解答了官网的话。如果是增加依赖执行也并无不同。最后再来看一下整个流程图")],-1),ts=(0,t._)("p",null,[(0,t._)("img",{src:e,alt:"computed"})],-1),es={},os=(0,a(3744).Z)(es,[["render",function(n,s){return(0,t.wg)(),(0,t.iD)(t.HY,null,[o,c,p,l,k,u,_,r,i,U,b,m,d,g,h,y,w,v,f,j,x,D,W,C,S,$,E,O,q,A,F,z,T,P,V,R,G,N,I,H,M,Y,X,Z,Q,B,J,K,L,nn,sn,an,tn,en,on,cn,pn,ln,kn,un,_n,rn,Un,bn,mn,dn,gn,hn,yn,wn,vn,fn,jn,xn,Dn,Wn,Cn,Sn,$n,En,On,qn,An,Fn,zn,Tn,Pn,Vn,Rn,Gn,Nn,In,Hn,Mn,Yn,Xn,Zn,Qn,Bn,Jn,Kn,Ln,ns,ss,as,ts],64)}]])},3744:(n,s)=>{s.Z=(n,s)=>{for(const[a,t]of s)n[a]=t;return n}},9067:(n,s,a)=>{n.exports=a.p+"assets/img/initComputed.fbb7f859.png"}}]);