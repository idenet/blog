import{c as n}from"./app.97cec709.js";import{_ as s}from"./plugin-vue_export-helper.21dcd24c.js";const a={},p=n(`<h1 id="fiber" tabindex="-1"><a class="header-anchor" href="#fiber" aria-hidden="true">#</a> fiber</h1><h2 id="react-15-\u5B58\u5728\u7684\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#react-15-\u5B58\u5728\u7684\u95EE\u9898" aria-hidden="true">#</a> React 15 \u5B58\u5728\u7684\u95EE\u9898</h2><p>React 16 \u4E4B\u524D\u7684\u7248\u672C\u6BD4\u5BF9\u66F4\u65B0 VirtualDOM \u7684\u8FC7\u7A0B\u662F\u91C7\u7528\u5FAA\u73AF\u52A0\u9012\u5F52\u5B9E\u73B0\u7684\uFF0C\u8FD9\u79CD\u6BD4\u5BF9\u65B9\u5F0F\u6709\u4E00\u4E2A\u95EE\u9898\uFF0C\u5C31\u662F\u4E00\u65E6\u4EFB\u52A1\u5F00\u59CB\u8FDB\u884C\u5C31\u65E0\u6CD5\u4E2D\u65AD\uFF0C\u5982\u679C\u5E94\u7528\u4E2D\u7EC4\u4EF6\u6570\u91CF\u5E9E\u5927\uFF0C\u4E3B\u7EBF\u7A0B\u88AB\u957F\u671F\u5360\u7528\uFF0C\u76F4\u5230\u6574\u68F5 VirtualDOM \u6811\u6BD4\u5BF9\u66F4\u65B0\u5B8C\u6210\u4E4B\u540E\u4E3B\u7EBF\u7A0B\u624D\u80FD\u88AB\u91CA\u653E\uFF0C\u4E3B\u7EBF\u7A0B\u624D\u80FD\u6267\u884C\u5176\u4ED6\u4EFB\u52A1\u3002\u8FD9\u5C31\u4F1A\u5BFC\u81F4\u4E00\u4E9B\u7528\u6237\u4EA4\u4E92\uFF0C\u52A8\u753B\u7B49\u4EFB\u52A1\u65E0\u6CD5\u7ACB\u5373\u5F97\u5230\u6267\u884C\uFF0C\u9875\u9762\u5C31\u4F1A\u4EA7\u751F\u5361\u987F, \u975E\u5E38\u7684\u5F71\u54CD\u7528\u6237\u4F53\u9A8C\u3002</p><p>\u6838\u5FC3\u95EE\u9898\uFF1A\u9012\u5F52\u65E0\u6CD5\u4E2D\u65AD\uFF0C\u6267\u884C\u91CD\u4EFB\u52A1\u8017\u65F6\u957F\u3002 JavaScript \u53C8\u662F\u5355\u7EBF\u7A0B\uFF0C\u65E0\u6CD5\u540C\u65F6\u6267\u884C\u5176\u4ED6\u4EFB\u52A1\uFF0C\u5BFC\u81F4\u4EFB\u52A1\u5EF6\u8FDF\u9875\u9762\u5361\u987F\uFF0C\u7528\u6237\u4F53\u9A8C\u5DEE\u3002</p><h2 id="\u89E3\u51B3\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#\u89E3\u51B3\u65B9\u6848" aria-hidden="true">#</a> \u89E3\u51B3\u65B9\u6848</h2><ol><li>\u5229\u7528\u6D4F\u89C8\u5668\u7A7A\u95F2\u65F6\u95F4\u6267\u884C\u4EFB\u52A1\uFF0C\u62D2\u7EDD\u957F\u65F6\u95F4\u5360\u7528\u4E3B\u7EBF\u7A0B</li><li>\u653E\u5F03\u9012\u5F52\u53EA\u91C7\u7528\u5FAA\u73AF\uFF0C\u56E0\u4E3A\u5FAA\u73AF\u53EF\u4EE5\u88AB\u4E2D\u65AD</li><li>\u4EFB\u52A1\u62C6\u5206\uFF0C\u5C06\u4EFB\u52A1\u62C6\u5206\u6210\u4E00\u4E2A\u4E2A\u7684\u5C0F\u4EFB\u52A1</li></ol><h2 id="requestidlecallback" tabindex="-1"><a class="header-anchor" href="#requestidlecallback" aria-hidden="true">#</a> requestIdleCallback</h2><p>\u5229\u7528\u6D4F\u89C8\u5668\u7684\u7A7A\u4F59\u65F6\u95F4\u6267\u884C\u4EFB\u52A1\uFF0C\u5982\u679C\u6709\u66F4\u9AD8\u4F18\u5148\u7EA7\u7684\u4EFB\u52A1\u8981\u6267\u884C\u65F6\uFF0C\u5F53\u524D\u6267\u884C\u7684\u4EFB\u52A1\u53EF\u4EE5\u88AB\u7EC8\u6B62\uFF0C\u4F18\u5148\u6267\u884C\u9AD8\u7EA7\u522B\u4EFB\u52A1\u3002</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// deadline.timeRemaining() \u83B7\u53D6\u6D4F\u89C8\u5668\u7684\u7A7A\u4F59\u65F6\u95F4</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>\u9875\u9762\u662F\u4E00\u5E27\u4E00\u5E27\u7ED8\u5236\u51FA\u6765\u7684\uFF0C\u5F53\u6BCF\u79D2\u7ED8\u5236\u7684\u5E27\u6570\u8FBE\u5230 60 \u65F6\uFF0C\u9875\u9762\u662F\u6D41\u7545\u7684\uFF0C\u5C0F\u4E8E\u8FD9\u4E2A\u503C\u65F6\uFF0C \u7528\u6237\u4F1A\u611F\u89C9\u5230\u5361\u987F</p><p>1s 60\u5E27\uFF0C\u6BCF\u4E00\u5E27\u5206\u5230\u7684\u65F6\u95F4\u662F 1000/60 \u2248 16 ms\uFF0C\u5982\u679C\u6BCF\u4E00\u5E27\u6267\u884C\u7684\u65F6\u95F4\u5C0F\u4E8E16ms\uFF0C\u5C31\u8BF4\u660E\u6D4F\u89C8\u5668\u6709\u7A7A\u4F59\u65F6\u95F4</p><p>\u5982\u679C\u4EFB\u52A1\u5728\u5269\u4F59\u7684\u65F6\u95F4\u5185\u6CA1\u6709\u5B8C\u6210\u5219\u4F1A\u505C\u6B62\u4EFB\u52A1\u6267\u884C\uFF0C\u7EE7\u7EED\u4F18\u5148\u6267\u884C\u4E3B\u4EFB\u52A1\uFF0C\u4E5F\u5C31\u662F\u8BF4 requestIdleCallback \u603B\u662F\u5229\u7528\u6D4F\u89C8\u5668\u7684\u7A7A\u4F59\u65F6\u95F4\u6267\u884C\u4EFB\u52A1</p><p>\u6D4B\u8BD5\u4E00\u6BB5\u4EE3\u7801</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playground<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>play<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>playground<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>work<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>start work<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>interaction<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>handle some user interaction<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">&lt;style&gt;
  .playground</span> <span class="token punctuation">{</span>
    <span class="token property">background</span><span class="token punctuation">:</span> palevioletred<span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
&lt;/style&gt;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> play <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;play&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> workBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;work&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> interactionBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;interaction&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> iterationCount <span class="token operator">=</span> <span class="token number">100000000</span>
<span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">var</span> <span class="token function-variable function">expensiveCalculation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">IdleDeadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>iterationCount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> IdleDeadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span>
      Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token operator">?</span> value <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> value <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    iterationCount <span class="token operator">=</span> iterationCount <span class="token operator">-</span> <span class="token number">1</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>expensiveCalculation<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

workBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>expensiveCalculation<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

interactionBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  play<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token string">&quot;palegreen&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>\u4ECE\u4E0A\u9762\u53EF\u4EE5\u770B\u51FA\uFF0C\u7528api\u6267\u884C\u5FAA\u73AF\u7684\u65F6\u5019\uFF0C\u6709\u4E3B\u7EBF\u7A0B\u8FDB\u6765\u662F\u53EF\u4EE5\u4E2D\u65AD\uFF0C\u6267\u884C\u4E3B\u7EBF\u7A0B\u7136\u540E\u7EE7\u7EED\u6267\u884C\u5FAA\u73AF\u7684</p><h2 id="\u5B9E\u73B0\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#\u5B9E\u73B0\u601D\u8DEF" aria-hidden="true">#</a> \u5B9E\u73B0\u601D\u8DEF</h2><p>\u5728 Fiber \u65B9\u6848\u4E2D\uFF0C\u4E3A\u4E86\u5B9E\u73B0\u4EFB\u52A1\u7684\u7EC8\u6B62\u518D\u7EE7\u7EED\uFF0CDOM\u6BD4\u5BF9\u7B97\u6CD5\u88AB\u5206\u6210\u4E86\u4E24\u90E8\u5206\uFF1A</p><ol><li>\u6784\u5EFA Fiber (\u53EF\u4E2D\u65AD)</li><li>\u63D0\u4EA4 Commit (\u4E0D\u53EF\u4E2D\u65AD)</li></ol><p>DOM \u521D\u59CB\u6E32\u67D3: virtualDOM -&gt; Fiber -&gt; Fiber[] -&gt; DOM</p><p>DOM \u66F4\u65B0\u64CD\u4F5C: newFiber vs oldFiber -&gt; Fiber[] -&gt; DOM</p><h3 id="\u6784\u5EFA-fiber" tabindex="-1"><a class="header-anchor" href="#\u6784\u5EFA-fiber" aria-hidden="true">#</a> \u6784\u5EFA fiber</h3><p>\u548C \u4E4B\u524D\u7684 Vdom \u4E00\u6837\uFF0C fiber\u4E5F\u662F\u4E00\u4E2A\u5BF9\u8C61\uFF0C\u53EA\u662F\u5BF9\u8C61\u5C5E\u6027\u6BD4 Vdom \u591A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>{
  type         \u8282\u70B9\u7C7B\u578B (\u5143\u7D20, \u6587\u672C, \u7EC4\u4EF6)(\u5177\u4F53\u7684\u7C7B\u578B)
  props        \u8282\u70B9\u5C5E\u6027
  stateNode    \u8282\u70B9 DOM \u5BF9\u8C61 | \u7EC4\u4EF6\u5B9E\u4F8B\u5BF9\u8C61
  tag          \u8282\u70B9\u6807\u8BB0 (\u5BF9\u5177\u4F53\u7C7B\u578B\u7684\u5206\u7C7B hostRoot || hostComponent || classComponent || functionComponent)
  effects      \u6570\u7EC4, \u5B58\u50A8\u9700\u8981\u66F4\u6539\u7684 fiber \u5BF9\u8C61
  effectTag    \u5F53\u524D Fiber \u8981\u88AB\u6267\u884C\u7684\u64CD\u4F5C (\u65B0\u589E, \u5220\u9664, \u4FEE\u6539)
  return       \u5F53\u524D Fiber \u7684\u7236\u7EA7 Fiber
  child        \u5F53\u524D Fiber \u7684\u5B50\u7EA7 Fiber
  sibling      \u5F53\u524D Fiber \u7684\u4E0B\u4E00\u4E2A\u5144\u5F1F Fiber
  alternate    Fiber \u5907\u4EFD fiber \u6BD4\u5BF9\u65F6\u4F7F\u7528
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="\u5B9E\u73B0\u7B80\u6613-fiber" tabindex="-1"><a class="header-anchor" href="#\u5B9E\u73B0\u7B80\u6613-fiber" aria-hidden="true">#</a> \u5B9E\u73B0\u7B80\u6613 fiber</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span>

<span class="token keyword">const</span> jsx <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;a1&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;b1&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;c1&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;c2&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;b2&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>

<span class="token doc-comment comment">/**
 * 1. \u4E3A\u6BCF\u4E00\u4E2A\u8282\u70B9\u6784\u5EFA Fiber \u5BF9\u8C61
 * 2. \u6784\u5EFA Fiber \u94FE\u8868
 * 3. \u63D0\u4EA4 Fiber \u94FE\u63A5
 */</span>

<span class="token comment">// \u521B\u5EFA\u6839\u5143\u7D20 Fiber \u5BF9\u8C61</span>
<span class="token keyword">const</span> workInProgressRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
  stateNode<span class="token operator">:</span> container<span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>jsx<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u4E0B\u4E00\u4E2A\u8981\u6267\u884C\u7684\u4EFB\u52A1</span>
<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> workInProgressRoot

<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// \u5982\u679C\u4E0B\u4E00\u4E2A\u8981\u6784\u5EFA\u7684\u6267\u884C\u5355\u5143\u5B58\u5728\u5E76\u4E14\u6D4F\u89C8\u5668\u6709\u7A7A\u4F59\u65F6\u95F4</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u6784\u5EFA\u6267\u884C\u5355\u5143\u5E76\u8FD4\u56DE\u65B0\u7684\u6267\u884C\u5355\u5143</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// \u5982\u679C\u6240\u6709\u7684\u6267\u884C\u5355\u5143\u90FD\u5DF2\u7ECF\u6784\u5EFA\u5B8C\u6210</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u8FDB\u5165\u5230\u7B2C\u4E8C\u4E2A\u9636\u6BB5 \u6267\u884C DOM \u64CD\u4F5C</span>
    <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// Fiber \u5DE5\u4F5C\u7684\u7B2C\u4E00\u4E2A\u9636\u6BB5</span>
<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// \u6784\u5EFA\u9636\u6BB5\u5411\u4E0B\u8D70\u7684\u8FC7\u7A0B</span>
  <span class="token comment">// 1. \u521B\u5EFA\u5F53\u524D Fiber \u8282\u70B9\u7684 DOM \u5BF9\u8C61\u5E76\u5B58\u50A8\u5728 stateNode \u5C5E\u6027\u4E2D</span>
  <span class="token comment">// 2. \u6784\u5EFA\u5B50\u7EA7 Fiber \u5BF9\u8C61</span>
  <span class="token function">beginWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span>
  <span class="token comment">// \u5982\u679C\u5B50\u7EA7\u5B58\u5728</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u8FD4\u56DE\u5B50\u7EA7 \u6784\u5EFA\u5B50\u7EA7\u7684\u5B50\u7EA7</span>
    <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child
  <span class="token punctuation">}</span>
  <span class="token comment">// \u5F00\u59CB\u6784\u5EFA\u9636\u6BB5\u5411\u4E0A\u8D70\u7684\u8FC7\u7A0B</span>
  <span class="token comment">// \u5982\u679C\u7236\u7EA7\u5B58\u5728</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u6784\u5EFA Fiber \u94FE\u8868 \u4ECE\u5E95\u90E8\u5F00\u59CB\u6784\u5EFA</span>
    <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span>
    <span class="token comment">// \u5982\u679C\u540C\u7EA7\u5B58\u5728</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// \u8FD4\u56DE\u540C\u7EA7 \u6784\u5EFA\u540C\u7EA7\u7684\u5B50\u7EA7</span>
      <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>sibling
    <span class="token punctuation">}</span>
    <span class="token comment">// \u540C\u7EA7\u4E0D\u5B58\u5728 \u9000\u56DE\u7236\u7EA7 \u770B\u7236\u7EA7\u662F\u5426\u6709\u540C\u7EA7</span>
    workInProgress <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>return
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// \u5982\u679C Fiber \u5BF9\u8C61\u6CA1\u6709\u5B58\u50A8\u5176\u5BF9\u5E94\u7684 DOM \u5BF9\u8C61</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u521B\u5EFA DOM \u5BF9\u8C61\u5E76\u5B58\u50A8\u5728 Fiber \u5BF9\u8C61\u4E2D</span>
    workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
    <span class="token comment">// \u4E3A DOM \u5BF9\u8C61\u6DFB\u52A0\u5C5E\u6027</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> attr <span class="token keyword">in</span> workInProgress<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>attr <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">[</span>attr<span class="token punctuation">]</span> <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>props<span class="token punctuation">[</span>attr<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// \u521B\u5EFA\u5B50\u7EA7 Fiber \u5BF9\u8C61</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u8BB0\u5F55\u4E0A\u4E00\u6B21\u521B\u5EFA\u7684\u5B50\u7EA7 Fiber \u5BF9\u8C61</span>
    <span class="token keyword">let</span> previousFiber <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// \u904D\u5386\u5B50\u7EA7</span>
    workInProgress<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// \u521B\u5EFA\u5B50\u7EA7 Fiber \u5BF9\u8C61</span>
      <span class="token keyword">let</span> childFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> child<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        props<span class="token operator">:</span> child<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        <span class="token keyword">return</span><span class="token operator">:</span> workInProgress<span class="token punctuation">,</span>
        effectTag<span class="token operator">:</span> <span class="token string">&quot;PLACEMENT&quot;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// \u7B2C\u4E00\u4E2A\u5B50\u7EA7\u6302\u8F7D\u5230\u7236\u7EA7\u7684 child \u5C5E\u6027\u4E2D</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> childFiber
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5176\u4ED6\u5B50\u7EA7\u6302\u8F7D\u5230\u81EA\u5DF1\u7684\u4E0A\u4E00\u4E2A\u5144\u5F1F\u7684 sibling \u5C5E\u6027\u4E2D</span>
        previousFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> childFiber
      <span class="token punctuation">}</span>
      <span class="token comment">// \u66F4\u65B0\u4E0A\u4E00\u4E2A\u5B50\u7EA7</span>
      previousFiber <span class="token operator">=</span> childFiber
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// \u83B7\u53D6\u5F53\u524D fiber \u7684\u7236\u7EA7</span>
  <span class="token keyword">let</span> returnFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>return

  <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u94FE\u5934\u4E0A\u79FB</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>firstEffect
    <span class="token punctuation">}</span>
    <span class="token comment">// lastEffect \u4E0A\u79FB</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>lastEffect
    <span class="token punctuation">}</span>
    <span class="token comment">// \u6784\u5EFA\u94FE\u8868 \u9700\u8981\u8FDB\u884Cdom\u64CD\u4F5C</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>effectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> workInProgress
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgress
      <span class="token punctuation">}</span>
      returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> workInProgress
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Fiber \u5DE5\u4F5C\u7684\u7B2C\u4E8C\u9636\u6BB5</span>
<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// \u83B7\u53D6\u94FE\u8868\u4E2D\u7B2C\u4E00\u4E2A\u8981\u6267\u884C\u7684 DOM \u64CD\u4F5C</span>
  <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>firstEffect
  <span class="token comment">// \u5224\u65AD\u8981\u6267\u884C DOM \u64CD\u4F5C\u7684 Fiber \u5BF9\u8C61\u662F\u5426\u5B58\u5728</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u6267\u884C DOM \u64CD\u4F5C</span>
    currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span>
    <span class="token comment">// \u4ECE\u94FE\u8868\u4E2D\u53D6\u51FA\u4E0B\u4E00\u4E2A\u8981\u6267\u884C DOM \u64CD\u4F5C\u7684 Fiber \u5BF9\u8C61</span>
    currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>nextEffect
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// \u5728\u6D4F\u89C8\u5668\u7A7A\u95F2\u7684\u65F6\u5019\u5F00\u59CB\u6784\u5EFA</span>
<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br></div></div>`,27);function t(e,o){return p}var r=s(a,[["render",t]]);export{r as default};
