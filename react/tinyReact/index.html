<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.33">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="manifest" href="/blog/manifest.webmanifest"><meta name="theme-color" content="#3eaf7c"><link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileColor" content="#000000"><title>TinyReact | 斌</title><meta name="description" content="斌的学习记录">
    <link rel="modulepreload" href="/blog/assets/app.6a7f8286.js"><link rel="modulepreload" href="/blog/assets/index.html.656f76ff.js"><link rel="modulepreload" href="/blog/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/blog/assets/index.html.d204916b.js">
    <link rel="stylesheet" href="/blog/assets/style.f4e8be15.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><!----><span class="site-name">斌</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/blog/review/html" class="" aria-label="前端基础/面试"><!--[--><!--]--> 前端基础/面试 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/vue/example/" class="" aria-label="Vue源码分析"><!--[--><!--]--> Vue源码分析 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/vue-next/reactive/" class="" aria-label="vue-next"><!--[--><!--]--> vue-next <!--[--><!--]--></a></div><div class="navbar-item"><a aria-current="page" href="/blog/react/tinyReact/" class="router-link-active router-link-exact-active router-link-active" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/ts/challenge/" class="" aria-label="typescript"><!--[--><!--]--> typescript <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/micro-front/intro/" class="" aria-label="微前端"><!--[--><!--]--> 微前端 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/performance/" class="" aria-label="性能优化"><!--[--><!--]--> 性能优化 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/idenet/blog" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/blog/review/html" class="" aria-label="前端基础/面试"><!--[--><!--]--> 前端基础/面试 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/vue/example/" class="" aria-label="Vue源码分析"><!--[--><!--]--> Vue源码分析 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/vue-next/reactive/" class="" aria-label="vue-next"><!--[--><!--]--> vue-next <!--[--><!--]--></a></div><div class="navbar-item"><a aria-current="page" href="/blog/react/tinyReact/" class="router-link-active router-link-exact-active router-link-active" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/ts/challenge/" class="" aria-label="typescript"><!--[--><!--]--> typescript <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/micro-front/intro/" class="" aria-label="微前端"><!--[--><!--]--> 微前端 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/performance/" class="" aria-label="性能优化"><!--[--><!--]--> 性能优化 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/idenet/blog" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p class="sidebar-item sidebar-heading active">tiny-react <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/react/tinyReact/" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="TinyReact"><!--[--><!--]--> TinyReact <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/react/tinyReact/#创建-virtualdom" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建 virtualDOM"><!--[--><!--]--> 创建 virtualDOM <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/react/tinyReact/#将-vdom-转换成-真实-dom" class="router-link-active router-link-exact-active sidebar-item" aria-label="将 vDOM 转换成 真实 DOM"><!--[--><!--]--> 将 vDOM 转换成 真实 DOM <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/react/tinyReact/#给元素节点添加属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="给元素节点添加属性"><!--[--><!--]--> 给元素节点添加属性 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/blog/react/tinyReact/#渲染组件" class="router-link-active router-link-exact-active sidebar-item" aria-label="渲染组件"><!--[--><!--]--> 渲染组件 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/react/tinyReact/#函数组件" class="router-link-active router-link-exact-active sidebar-item" aria-label="函数组件"><!--[--><!--]--> 函数组件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/react/tinyReact/#渲染类组件" class="router-link-active router-link-exact-active sidebar-item" aria-label="渲染类组件"><!--[--><!--]--> 渲染类组件 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/blog/react/tinyReact/#vdom-对比更新" class="router-link-active router-link-exact-active sidebar-item" aria-label="VDOM 对比更新"><!--[--><!--]--> VDOM 对比更新 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/react/tinyReact/#vdom-是相同类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="vdom 是相同类型"><!--[--><!--]--> vdom 是相同类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/react/tinyReact/#vdom是不同类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="vdom是不同类型"><!--[--><!--]--> vdom是不同类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/react/tinyReact/#删除节点" class="router-link-active router-link-exact-active sidebar-item" aria-label="删除节点"><!--[--><!--]--> 删除节点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/react/tinyReact/#类组件状态更新" class="router-link-active router-link-exact-active sidebar-item" aria-label="类组件状态更新"><!--[--><!--]--> 类组件状态更新 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/react/tinyReact/#组件更新" class="router-link-active router-link-exact-active sidebar-item" aria-label="组件更新"><!--[--><!--]--> 组件更新 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/blog/react/tinyReact/#ref-属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="ref 属性"><!--[--><!--]--> ref 属性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/react/tinyReact/#key-属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="key 属性"><!--[--><!--]--> key 属性 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/react/tinyReact/#key-属性节点对比" class="router-link-active router-link-exact-active sidebar-item" aria-label="key 属性节点对比"><!--[--><!--]--> key 属性节点对比 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/react/tinyReact/#节点卸载" class="router-link-active router-link-exact-active sidebar-item" aria-label="节点卸载"><!--[--><!--]--> 节点卸载 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><p class="sidebar-item sidebar-heading">fiber <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/blog/react/fiber/" class="sidebar-item" aria-label="fiber"><!--[--><!--]--> fiber <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="tinyreact" tabindex="-1"><a class="header-anchor" href="#tinyreact" aria-hidden="true">#</a> TinyReact</h1><p>从创建一个微小的 react 来了解<code>virtualDOM</code>的的渲染流程。所有的代码可以在 <a href="https://github.com/idenet/tiny-react" target="_blank" rel="noopener noreferrer">这里<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>可以看到，<code>master</code>是所有实现，<code>init</code>是未实现的<code>tempalte</code></p><p><strong>注意</strong> 在<code>babelrc</code>中有一段代码，将<code>react</code>预置转换成了我们需要的<code>TinyReact</code></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
  &quot;@babel/preset-react&quot;,
   {
      &quot;pragma&quot;: &quot;TinyReact.createElement&quot;
   }
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这样我们就能拿到<code>react</code>转换后的js代码，到我们自己的<code>TinyReact</code></p><h2 id="创建-virtualdom" tabindex="-1"><a class="header-anchor" href="#创建-virtualdom" aria-hidden="true">#</a> 创建 virtualDOM</h2><p>在 TinyReact 文件夹中创建</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// createElement.js</span>
<span class="token doc-comment comment">/**
 * 创建 Virtual DOM
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">type</span> 类型
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>object <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">}</span></span> <span class="token parameter">props</span> 属性
 * <span class="token keyword">@param</span>  <span class="token class-name"><span class="token punctuation">{</span>createElement<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span> <span class="token parameter">children</span> 子元素
 * <span class="token keyword">@return</span> <span class="token class-name"><span class="token punctuation">{</span>object<span class="token punctuation">}</span></span> Virtual DOM
 */</span>
<span class="token keyword">function</span> <span class="token function">createElement</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    children
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在出口中导出 createElment.js</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> createElement <span class="token keyword">from</span> <span class="token string">&#39;./createElement&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在入口 <code>index.js</code>中使用代码</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> TinyReact <span class="token keyword">from</span> <span class="token string">&#39;./TinyReact&#39;</span>

<span class="token keyword">const</span> virtualDOM <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;container&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>你好 Tiny React<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span><span class="token punctuation">(</span>编码必杀技<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      嵌套<span class="token number">1</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>嵌套 <span class="token number">1.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h3<span class="token operator">&gt;</span><span class="token punctuation">(</span>观察<span class="token operator">:</span> 这个将会被改变<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>如果<span class="token number">2</span>和<span class="token number">1</span>相等渲染当前内容<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>这是一段内容<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;你好&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>点击我<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h3<span class="token operator">&gt;</span>这个将会被删除<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
<span class="token function">TinyReact</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> root<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这里就拿到了<code>react</code>创建的<code>virtaulDOM</code>对象，但是通过以上代码我们发现 VDOM 存在一些问题， 第一个问题是文本节点北直街放到了数组中，第二个问题是排除布尔值和null的节点, 第三点props可以拿到children</p><p><img src="/blog/assets/1.cdc6c385.png" alt="问题1"></p><p>但是我们希望文本节点也是放在对象中的，所以我们需要对 createElement 进行改造</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 由于 map 方法无法从数据中刨除元素, 所以此处将 map 方法更改为 reduce 方法</span>
  <span class="token keyword">const</span> childElements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token operator">...</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token comment">// 判断子元素类型 刨除 null true false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> child <span class="token operator">!==</span> <span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断 child 是否是对象类型</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;text&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">textContent</span><span class="token operator">:</span> child <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将需要保留的 Virtual DOM 放入 result 数组</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">children</span><span class="token operator">:</span> childElements <span class="token punctuation">}</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span> childElements<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="将-vdom-转换成-真实-dom" tabindex="-1"><a class="header-anchor" href="#将-vdom-转换成-真实-dom" aria-hidden="true">#</a> 将 vDOM 转换成 真实 DOM</h2><p>导出一个 render 函数，用来实现真实 dom</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> createElement <span class="token keyword">from</span> <span class="token string">&#39;./createElement&#39;</span>
<span class="token keyword">import</span> render <span class="token keyword">from</span> <span class="token string">&#39;./render&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
  render<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>入口代码更改</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> TinyReact <span class="token keyword">from</span> <span class="token string">&#39;./TinyReact&#39;</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> virtualDOM <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;container&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>你好 Tiny React<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span><span class="token punctuation">(</span>编码必杀技<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      嵌套<span class="token number">1</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>嵌套 <span class="token number">1.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h3<span class="token operator">&gt;</span><span class="token punctuation">(</span>观察<span class="token operator">:</span> 这个将会被改变<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>如果<span class="token number">2</span>和<span class="token number">1</span>相等渲染当前内容<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>这是一段内容<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;你好&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>点击我<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h3<span class="token operator">&gt;</span>这个将会被删除<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>

TinyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> root<span class="token punctuation">)</span>
<span class="token comment">// react渲染完成后的vdom 类似</span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">&quot;container&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;h3&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">textContent</span><span class="token operator">:</span> <span class="token string">&quot;Hello React&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">textContent</span><span class="token operator">:</span> <span class="token string">&quot;React is great&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>render 函数的实现。他接收 VDOM，根节点，oldDOM(用于之后的比对)</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// render.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在 diff 方法内部判断是否需要对比 对比也好 不对比也好 都在 diff 方法中进行操作  </span>
  <span class="token function">diff</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// diff.js</span>
<span class="token keyword">import</span> mountElement <span class="token keyword">from</span> <span class="token string">&quot;./mountElement&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断 oldDOM 是否存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不存在 不需要对比 直接将 Virtual DOM 转换为真实 DOM</span>
    <span class="token function">mountElement</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这里我们还要处理他是否是vDOM，还是组件，所以我们还需要一个函数来判断</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// mountElement.js</span>
<span class="token keyword">import</span> mountNativeElement <span class="token keyword">from</span> <span class="token string">&quot;./mountNativeElement&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过调用 mountNativeElement 方法转换 Native Element</span>
  <span class="token function">mountNativeElement</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// mountNativeElement.js</span>
<span class="token keyword">import</span> createDOMElement <span class="token keyword">from</span> <span class="token string">&quot;./createDOMElement&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountNativeElement</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newElement <span class="token operator">=</span> <span class="token function">createDOMElement</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span>
  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在我们创建完节点之后，其实他的属性并没有添加到节点之上，我们需要一个函数来将属性，value等添加到上面</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// createDOMElement.js</span>
<span class="token keyword">import</span> mountElement <span class="token keyword">from</span> <span class="token string">&quot;./mountElement&quot;</span>
<span class="token keyword">import</span> updateNodeElement <span class="token keyword">from</span> <span class="token string">&quot;./updateNodeElement&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createDOMElement</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> newElement <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建文本节点</span>
    newElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建元素节点</span>
    newElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
    <span class="token comment">// 更新元素属性</span>
    <span class="token function">updateNodeElement</span><span class="token punctuation">(</span>newElement<span class="token punctuation">,</span> virtualDOM<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 递归渲染子节点</span>
  virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为不确定子元素是 NativeElement 还是 Component 所以调用 mountElement 方法进行确定</span>
    <span class="token function">mountElement</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> newElement
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="给元素节点添加属性" tabindex="-1"><a class="header-anchor" href="#给元素节点添加属性" aria-hidden="true">#</a> 给元素节点添加属性</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// updateNodeElement.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">updateNodeElement</span><span class="token punctuation">(</span><span class="token parameter">newElment<span class="token punctuation">,</span> virtualDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取节点对应的属性对象</span>
  <span class="token keyword">const</span> newProps <span class="token operator">=</span> virtualDOM<span class="token punctuation">.</span>props
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">propName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newPropsValue <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span>
    <span class="token comment">// 判断属性是否是事件属性 onClick -&gt; click</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;on&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 事件名称</span>
      <span class="token keyword">const</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token comment">// 为元素添加事件</span>
      newElment<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> newPropsValue<span class="token punctuation">)</span>
      <span class="token comment">// 如果属性名称是 value 或者 checked 需要通过 [] 的形式添加</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;value&#39;</span> <span class="token operator">||</span> propName <span class="token operator">===</span> <span class="token string">&#39;checked&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newElment<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> newPropsValue
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// className 属性单独处理 不直接在元素上添加 class 属性是因为 class 是 JavaScript 中的关键字</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;className&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newElment<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;class&#39;</span><span class="token punctuation">,</span> newPropsValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置普通属性</span>
        newElment<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span> newPropsValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="渲染组件" tabindex="-1"><a class="header-anchor" href="#渲染组件" aria-hidden="true">#</a> 渲染组件</h2><h3 id="函数组件" tabindex="-1"><a class="header-anchor" href="#函数组件" aria-hidden="true">#</a> 函数组件</h3><p>替换入口渲染位函数组件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>hello<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">Heart</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">&lt;</span>Demo<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Demo<span class="token operator">&gt;</span>

TinyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Heart<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Heart<span class="token operator">&gt;</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span>

<span class="token comment">// 组件的 Virtual DOM</span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> f <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在渲染组件时，要先将 Component 与 Native Element 区分开，如果是 Native Element 可以直接开始渲染，如果是组件，特别处理。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> mountNativeElment <span class="token keyword">from</span> <span class="token string">&#39;./mountNativeElement&#39;</span>
<span class="token keyword">import</span> isFunction <span class="token keyword">from</span> <span class="token string">&#39;./isFunction&#39;</span>
<span class="token keyword">import</span> mountComponent <span class="token keyword">from</span> <span class="token string">&#39;./mountComponent&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 无论是类组件还是函数组件 其实本质上都是函数 </span>
  <span class="token comment">// 如果 Virtual DOM 的 type 属性值为函数 就说明当前这个 Virtual DOM 为组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Component</span>
    <span class="token function">mountComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Component vs MativeElment</span>
    <span class="token function">mountNativeElment</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Virtual DOM 是否为函数类型</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> virtualDOM <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>在 mountComponent 方法中再进行函数组件和类型的区分，然后再分别进行处理。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// mountComponent.js</span>
<span class="token keyword">import</span> mountNativeElement <span class="token keyword">from</span> <span class="token string">&quot;./mountNativeElement&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 存放组件调用后返回的 vdom 的容器</span>
  <span class="token keyword">let</span> nextVirtualDOM <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">// 区分函数型组件和类组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunctionalComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 函数组件 调用 buildFunctionalComponent 方法处理函数组件</span>
    nextVirtualDOM <span class="token operator">=</span> <span class="token function">buildFunctionalComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//TODO 类组件</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 判断得到的 vdom 是否是组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>nextVirtualDOM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是组件 继续调用 mountComponent 解剖组件</span>
    <span class="token function">mountComponent</span><span class="token punctuation">(</span>nextVirtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是 Navtive Element 就去渲染</span>
    <span class="token function">mountNativeElement</span><span class="token punctuation">(</span>nextVirtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// vdom 是否为函数型组件</span>
<span class="token comment">// 条件有两个: 1. vdom 的 type 属性值为函数 2. 函数的原型对象中不能有render方法</span>
<span class="token comment">// 只有类组件的原型对象中有render方法 </span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isFunctionalComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> virtualDOM <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>type
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    type <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>prototype <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>render<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 函数组件处理 </span>
<span class="token keyword">function</span> <span class="token function">buildFunctionalComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过 vdom 中的 type 属性获取到组件函数并调用</span>
  <span class="token comment">// 调用组件函数时将 vdom 对象中的 props 属性传递给组件函数 这样在组件中就可以通过 props 属性获取数据了</span>
  <span class="token comment">// 组件返回要渲染的 vdom</span>
  <span class="token keyword">return</span> virtualDOM <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>这样函数组件就处理完成了。这里注意如果函数组件中有函数组件，他的先后调用顺序是什么? 我们注意这段代码，在正常的走到渲染真实dom的时候，我们会递归调用 children ，在这里，调用了 <code>mountElement</code>, 在<code>mountElement</code>中，继续判断了<code>Vdom</code>是组件还是虚拟dom</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 递归渲染子节点</span>
virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 因为不确定子元素是 NativeElement 还是 Component 所以调用 mountElement 方法进行确定</span>
  <span class="token function">mountElement</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="渲染类组件" tabindex="-1"><a class="header-anchor" href="#渲染类组件" aria-hidden="true">#</a> 渲染类组件</h3><p>类组件本身也是VDOM，可以通过 VDOM中的type来确定当前是类组件还是函数组件 在确定是类组件后，通过实例化组件调用组件中的render方法，获取需要渲染的VOM。 类组件继承自 Component 父类，子类通过super方法将自身的props属性传递给父类，父类将props属性挂载为父类属性，这样子类也具有了 props属性。这么做的好处是，当props发生更新后，父类可以根据更新后的props帮助子类更新视图</p><p>假设以下代码就是我们要渲染的类组件：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token keyword">extends</span> <span class="token class-name">TinyReact<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将 props 传递给父类 子类继承父类的 props 子类自然就有 props 数据了</span>
    <span class="token comment">// 否则 props 仅仅是 constructor 函数的参数而已</span>
    <span class="token comment">// 将 props 传递给父类的好处是 当 props 发生更改时 父类可以帮助更新 props 更新组件视图</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

TinyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Alert message<span class="token operator">=</span><span class="token string">&quot;Hello React&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>在出口处导出 Component</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> createElement <span class="token keyword">from</span> <span class="token string">&#39;./createElement&#39;</span>
<span class="token keyword">import</span> render <span class="token keyword">from</span> <span class="token string">&#39;./render&#39;</span>
<span class="token keyword">import</span> Component <span class="token keyword">from</span> <span class="token string">&#39;./Component&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
  render<span class="token punctuation">,</span>
  Component<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在 mountComponent中判断是类组件还是函数组件，通过其分别调用函数处理</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// mountComponent.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> nextVirtualDOM <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">// 区分函数型组件和类组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunctionalComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 函数组件</span>
    nextVirtualDOM <span class="token operator">=</span> <span class="token function">buildFunctionalComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 类组件</span>
    nextVirtualDOM <span class="token operator">=</span> <span class="token function">buildStatefulComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 判断得到的 Virtual Dom 是否是组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>nextVirtualDOM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mountComponent</span><span class="token punctuation">(</span>nextVirtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">mountNativeElement</span><span class="token punctuation">(</span>nextVirtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 处理类组件</span>
<span class="token keyword">function</span> <span class="token function">buildClassComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 实例化class组件 传递props</span>
  <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">virtualDOM<span class="token punctuation">.</span>type</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 调用类组件中的render方法得到要渲染的 Virtual DOM</span>
  <span class="token keyword">const</span> nextVirtualDOM <span class="token operator">=</span> component<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 返回要渲染的 Virtual DOM</span>
  <span class="token keyword">return</span> nextVirtualDOM
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>创建 Component 父类，赋值 props 属性，这样子类也能拿到了</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="vdom-对比更新" tabindex="-1"><a class="header-anchor" href="#vdom-对比更新" aria-hidden="true">#</a> VDOM 对比更新</h2><p>在新旧dom树的对比过程中，如何拿到旧的dom是第一个问题？其实在页面上已经有了真实的dom对象， 那么可以给真实的dom对象添加一个属性，这个属性就是旧的VDOM，这样就能很容易的拿到了</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createDomElelment</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 将 Virtual DOM 挂载到真实 DOM 对象的属性中 方便在对比时获取其 Virtual DOM</span>
  newElment<span class="token punctuation">.</span>_virtualDOM <span class="token operator">=</span> virtualDOM
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后在render函数中拿到oldDOM, 为什么是 container.firstChild, 因为每一个组件都有一个父亲节点， 出口就是<code>&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</code>，它也是一个父亲节点，所以其第一个元素就是<code>oldDOM</code></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span>
  virtualDOM<span class="token punctuation">,</span>
  container<span class="token punctuation">,</span>
  <span class="token comment">// 拿到第一个元素</span>
  oldDOM <span class="token operator">=</span> container<span class="token punctuation">.</span>firstChild
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">diff</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="vdom-是相同类型" tabindex="-1"><a class="header-anchor" href="#vdom-是相同类型" aria-hidden="true">#</a> vdom 是相同类型</h3><p>判断 oldVirtualDOM 是否存在， 如果存在则继续判断要对比的 Virtual DOM 类型是否相同， 如果类型相同判断节点类型是否是文本，如果是文本节点对比，就调用 updateTextNode 方法；如果是元素节点就调用 updateNodeElement，这个方法其实就是更新元素的方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取未更新前的 Virtual DOM</span>
  <span class="token keyword">const</span> oldVirtualDOM <span class="token operator">=</span> oldDOM <span class="token operator">&amp;&amp;</span> oldDOM<span class="token punctuation">.</span>_virtualDOM
  <span class="token comment">// 判断oldDOM 是否存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mountElement</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
    <span class="token comment">// 存在oldVdom，且两者类型相同</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVirtualDOM <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> oldVirtualDOM<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;text&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新内容 找到差异更新到真实dom oldDOM</span>
      <span class="token function">updateTextNode</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldVirtualDOM<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新元素属性</span>
      <span class="token function">updateNodeElement</span><span class="token punctuation">(</span>oldDOM<span class="token punctuation">,</span> virtualDOM<span class="token punctuation">,</span> oldVirtualDOM<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 循环子元素，将子元素进行更新</span>
    virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">diff</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> oldDOM<span class="token punctuation">,</span> oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>updateTextNode 方法用于对比文本节点内容是否发生变化，如果发生变化则更新真实 DOM 对象中的内容，既然真实 DOM 对象发生了变化，还要将最新的 Virtual DOM 同步给真实 DOM 对象。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">updateTextNode</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> oldVirtualDOM<span class="token punctuation">,</span> oldDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果两者文本节点不相等</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>textContent <span class="token operator">!==</span> oldVirtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将虚拟dom的文本内容复制给真实dom</span>
    oldDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>textContent
    <span class="token comment">// 同步真实dom对应的vdom</span>
    oldDOM<span class="token punctuation">.</span>_virtualDOM <span class="token operator">=</span> virtualDOM
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>updateNodeElement 用于设置/更新元素节点属性 思路是</p><ol><li><p>先分别获取更新后的和更新前的 Virtual DOM 中的 props 属性，循环新 Virtual DOM 中的 props 属性，通过对比看一下新 Virtual DOM 中的属性值是否发生了变化，如果发生变化 需要将变化的值更新到真实 DOM 对象中</p></li><li><p>再循环未更新前的 Virtual DOM 对象，通过对比看看新的 Virtual DOM 中是否有被删除的属性，如果存在删除的属性 需要将 DOM 对象中对应的属性也删除掉</p></li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">updateNodeElement</span><span class="token punctuation">(</span>
  <span class="token parameter">newElment<span class="token punctuation">,</span>
  virtualDOM<span class="token punctuation">,</span>
  oldVirtualDOM <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//  获取节点对应的属性对象</span>
  <span class="token comment">// 从新props中判断属性被添加的情况</span>
  <span class="token keyword">const</span> newProps <span class="token operator">=</span> virtualDOM<span class="token punctuation">.</span>props
  <span class="token keyword">const</span> oldProps <span class="token operator">=</span> oldVirtualDOM<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 首次渲染没有oldVirtaulDOM</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">propName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取属性值</span>
    <span class="token keyword">const</span> newPropsValue <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span>
    <span class="token keyword">const</span> oldPropsValue <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>newPropsValue <span class="token operator">!==</span> oldPropsValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断属性是否是事件属性 onClick -&gt; click</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;on&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 事件名称</span>
        <span class="token keyword">const</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment">// 为元素添加事件</span>
        newElment<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> newPropsValue<span class="token punctuation">)</span>
        <span class="token comment">// 删除原有的事件的事件处理函数 同名</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPropsValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          newElment<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> oldPropsValue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;value&#39;</span> <span class="token operator">||</span> propName <span class="token operator">===</span> <span class="token string">&#39;checked&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newElment<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> newPropsValue
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;className&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          newElment<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;class&#39;</span><span class="token punctuation">,</span> newPropsValue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          newElment<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span> newPropsValue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 从oldProps中 判断属性被删除的情况</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">propName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newPropsValue <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span>
    <span class="token keyword">const</span> oldPropsValue <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newPropsValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 属性被删除了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;on&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        newElment<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> oldPropsValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newElment<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>节点更新使用的是深度优先的遍历顺序</p><p><img src="/blog/assets/2.84eef488.png" alt="遍历顺序"></p><h3 id="vdom是不同类型" tabindex="-1"><a class="header-anchor" href="#vdom是不同类型" aria-hidden="true">#</a> vdom是不同类型</h3><p>当对比的元素节点类型不同时，就不需要继续对比了，直接使用新的 Virtual DOM 创建 DOM 对象，用新的 DOM 对象直接替换旧的 DOM 对象。当前这种情况要将组件刨除，组件要被单独处理。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// diff.js</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token comment">// 如果 Virtual DOM 类型不一样</span>
  virtualDOM<span class="token punctuation">.</span>type <span class="token operator">!==</span> oldVirtualDOM<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span>
  <span class="token comment">// 并且 Virtual DOM 不是组件 因为组件要单独进行处理</span>
  <span class="token keyword">typeof</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据 Virtual DOM 创建真实 DOM 元素</span>
  <span class="token keyword">const</span> newDOMElement <span class="token operator">=</span> <span class="token function">createDOMElement</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span>
  <span class="token comment">// 用创建出来的真实 DOM 元素 替换旧的 DOM 元素</span>
  oldDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOMElement<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="删除节点" tabindex="-1"><a class="header-anchor" href="#删除节点" aria-hidden="true">#</a> 删除节点</h3><p>删除节点发生在节点更新以后并且发生在同一个父节点下的所有子节点身上。</p><p>在节点更新完成以后，如果旧节点对象的数量多于新 VirtualDOM 节点的数量，就说明有节点需要被删除。</p><p><img src="/blog/assets/3.14b0ad9e.png" alt="删除"></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 判断oldDOM 是否存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>type <span class="token operator">!==</span> oldVirtualDOM<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> virtualDOM<span class="token punctuation">,</span>
    type <span class="token operator">!==</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVirtualDOM <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> oldVirtualDOM<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token comment">// 删除节点</span>
    <span class="token comment">// 获取旧节点</span>
    <span class="token keyword">let</span> oldChildNodes <span class="token operator">=</span> oldDOM<span class="token punctuation">.</span>childNodes
    <span class="token comment">// 判断旧节点的数量</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildNodes <span class="token operator">/</span> length <span class="token operator">&gt;</span> virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 有节点需要被删除</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> oldChildNodes<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        i <span class="token operator">&gt;</span> virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        i<span class="token operator">--</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unmountNode</span><span class="token punctuation">(</span>oldChildNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">unmountNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="类组件状态更新" tabindex="-1"><a class="header-anchor" href="#类组件状态更新" aria-hidden="true">#</a> 类组件状态更新</h3><p>实现以下代码的功能，</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token keyword">extends</span> <span class="token class-name">TinyReact<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;default title&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 更改 handleChange 方法中的 this 指向 让 this 指向类实例对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用父类中的 setState 方法更改状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;changed title&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span><span class="token operator">&gt;</span>change title<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>setState 方法定义在父类中，该方法就是合并原有的state，产生新的state</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Component.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props
  <span class="token punctuation">}</span>
  <span class="token function">setState</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// setState 方法被子类调用 此处this指向子类实例对象</span>
    <span class="token comment">// 所以改变的是子类的 state 对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>现在子类可以调用父类的setState方法更改状态，当组件的state状态发生改变时，要调用render方法更新视图 在组件更新之时，我们需要比对新旧vdom 找出要更新的部分，这里this指向的是子类，所以调用render 就能获得 vdom</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Component.js</span>
<span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// setState 方法被子类调用 此处this指向子类</span>
  <span class="token comment">// 所以改变的是子类的 state</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token comment">// 通过调用 render 方法获取最新的 Virtual DOM</span>
  <span class="token keyword">let</span> virtualDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在父类Component设置两个函数用来存储dom和获取dom，</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Component.js</span>
<span class="token comment">// 保存 DOM 对象的方法</span>
<span class="token function">setDOM</span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_dom <span class="token operator">=</span> dom
<span class="token punctuation">}</span>
<span class="token comment">// 获取 DOM 对象的方法</span>
<span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_dom
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来我们要研究如何调用到setDOM方法，首先我们必须要具有实例，有实例才能调用方法，在<code>buildClassComponent</code>方法 中我们初始化了实例，并返回给了<code>nextVirtualDOM</code>, 它又被传入了<code>mountNativeElment</code>， 在这里我们拿到了真实dom，从前面我们知道， 在真实dom中我们把虚拟dom赋值给了<code>newElement</code>,综上所述</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// mountComponent.js</span>
<span class="token keyword">function</span> <span class="token function">buildClassComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 实例化class组件 传递props</span>
  <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">virtualDOM<span class="token punctuation">.</span>type</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 拿到render函数</span>
  <span class="token keyword">const</span> nextVirtualDOM <span class="token operator">=</span> component<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 将实例赋值给nextvirtualdom</span>
  nextVirtualDOM<span class="token punctuation">.</span>component <span class="token operator">=</span> component
  <span class="token keyword">return</span> nextVirtualDOM
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// mountNativeElment.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountNativeElment</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> newElment <span class="token operator">=</span> <span class="token function">createDomElelment</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span>
  <span class="token comment">// 将转换之后的对象，放置到页面中·</span>
  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newElment<span class="token punctuation">)</span>

  <span class="token comment">// 获取实例对象</span>
  <span class="token keyword">let</span> component <span class="token operator">=</span> virtualDOM<span class="token punctuation">.</span>component
  <span class="token comment">// 类组件存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    component<span class="token punctuation">.</span><span class="token function">setDOM</span><span class="token punctuation">(</span>newElment<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>现在更新前的 Virtual DOM 对象和更新后的 Virtual DOM 对象就都已经获取到了，接下来还要获取到真实 DOM 对象父级容器对象，最后调用diff就行了</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token comment">// 获取最新的要渲染的 virtualDOM 对象</span>
    <span class="token keyword">let</span> virtualDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 获取旧的 virtualDOM对象，进行比对</span>
    <span class="token keyword">let</span> oldDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 获取容器</span>
    <span class="token keyword">let</span> container <span class="token operator">=</span> oldDOM<span class="token punctuation">.</span>parentNode
    <span class="token comment">// 实现对比</span>
    <span class="token function">diff</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="组件更新" tabindex="-1"><a class="header-anchor" href="#组件更新" aria-hidden="true">#</a> 组件更新</h3><p>在 diff 方法中判断需要更新的 vdom 是不是组件，需要分多钟情况，新增 diffComponent 进行处理</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// diff.js</span>
<span class="token comment">// 旧的组件的实例对象</span>
<span class="token keyword">const</span> oldComponent <span class="token operator">=</span> oldVirtualDOM <span class="token operator">&amp;&amp;</span> oldVirtualDOM<span class="token punctuation">.</span>component
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 要更新的是组件</span>
  <span class="token comment">// 1) 组件本身的 virtualDOM 对象 通过它可以获取到组件最新的 props</span>
  <span class="token comment">// 2) 要更新的组件的实例对象 通过它可以调用组件的生命周期函数 可以更新组件的 props 属性 可以获取到组件返回的最新的 Virtual DOM</span>
  <span class="token comment">// 3) 要更新的 DOM 象 在更新组件时 需要在已有DOM对象的身上进行修改 实现DOM最小化操作 获取旧的 Virtual DOM 对象</span>
  <span class="token comment">// 4) 如果要更新的组件和旧组件不是同一个组件 要直接将组件返回的 Virtual DOM 显示在页面中 此时需要 container 做为父级容器</span>
  <span class="token function">diffComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldComponent<span class="token punctuation">,</span> oldDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="不是同一个组件" tabindex="-1"><a class="header-anchor" href="#不是同一个组件" aria-hidden="true">#</a> 不是同一个组件</h4><p>在 diffComponent 方法中判断需要更新的组件是不是同一个组件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// diffComponent.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">diffComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> oldComponent<span class="token punctuation">,</span> oldDOM<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断要更新的组件和未更新的组件是否是同一个组件 只需要确定两者使用的是否是同一个构造函数就可以了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 属同一个组件 做组件更新  </span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不是同一个组件 直接将组件内容显示在页面中</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// virtualDOM.type 更新后的组件构造函数</span>
<span class="token comment">// oldComponent.constructor 未更新前的组件构造函数</span>
<span class="token comment">// 两者等价就表示是同一组件</span>
<span class="token keyword">function</span> <span class="token function">isSameComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> oldComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> oldComponent <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> oldComponent<span class="token punctuation">.</span>constructor
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>如果不是同一个组件，则只需要将组件显示到页面，并且删除原有的dom就行</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// diffComponent.js</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 不是同一个组件 直接将组件内容显示在页面中</span>
  <span class="token comment">// 这里为 mountElement 方法新增了一个参数 oldDOM </span>
  <span class="token comment">// 作用是在将 DOM 对象插入到页面前 将页面中已存在的 DOM 对象删除 否则无论是旧DOM对象还是新DOM对象都会显示在页面中</span>
  <span class="token function">mountElement</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在 mountNativeElement 方法中删除原有的dom对象</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// mountNavtiveElement.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountNativeElement</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 如果旧的DOM对象存在 删除</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unmount</span><span class="token punctuation">(</span>oldDOM<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="是同一个组件" tabindex="-1"><a class="header-anchor" href="#是同一个组件" aria-hidden="true">#</a> 是同一个组件</h4><p>如果是同一个组件的话，需要执行组件更新操作，需要调用组件生命周期函数</p><p>先在 Component 类中添加生命周期函数，子类要使用的话直接覆盖就可以</p><p>并添加 updateProps 方法 用于更新props</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Component.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">updateProps</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props
  <span class="token punctuation">}</span>
  <span class="token comment">// 生命周期函数</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nextProps <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">||</span> nextState <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
  <span class="token punctuation">}</span>
  <span class="token function">componentWillUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> preState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>新建 updateComponent 方法用于更新组件的操作</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// diffComponent.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 属同一个组件 做组件更新</span>
  <span class="token function">updateComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldComponent<span class="token punctuation">,</span> oldDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在 updateComponent 方法中调用组件的生命周期函数，更新组件获取最新 Virtual DOM，最终调用 diff 方法进行更新</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> diff <span class="token keyword">from</span> <span class="token string">&quot;./diff&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">updateComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">virtualDOM<span class="token punctuation">,</span>
  oldComponent<span class="token punctuation">,</span>
  oldDOM<span class="token punctuation">,</span>
  container</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生命周期函数</span>
  oldComponent<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token comment">// 调用 shouldComponentUpdate 生命周期函数判断是否要执行更新操作</span>
    oldComponent<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将未更新的 props 保存一份</span>
    <span class="token keyword">let</span> prevProps <span class="token operator">=</span> oldComponent<span class="token punctuation">.</span>props
    <span class="token comment">// 生命周期函数</span>
    oldComponent<span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token comment">// 更新组件的 props 属性</span>
    oldComponent<span class="token punctuation">.</span><span class="token function">updateProps</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token comment">// 因为组件的 props 已经更新 所以调用 render 方法获取最新的 Virtual DOM</span>
    <span class="token keyword">const</span> nextVirtualDOM <span class="token operator">=</span> oldComponent<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 进行一系列操作后 将组件实例对象挂载到 Virtual DOM 身上</span>
    nextVirtualDOM<span class="token punctuation">.</span>component <span class="token operator">=</span> oldComponent
    <span class="token comment">// 调用diff方法更新视图</span>
    <span class="token function">diff</span><span class="token punctuation">(</span>nextVirtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
    <span class="token comment">// 生命周期函数</span>
    oldComponent<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="ref-属性" tabindex="-1"><a class="header-anchor" href="#ref-属性" aria-hidden="true">#</a> ref 属性</h2><p>为节点添加 ref 属性可以获取到这个节点的 DOM 对象，比如在 DemoRef 类中，为 input 元素添加了 ref 属性，目的是获取 input DOM 元素对象，在点击按钮时获取用户在文本框中输入的内容</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">class</span> <span class="token class-name">DemoRef</span> <span class="token keyword">extends</span> <span class="token class-name">TinyReact<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>input<span class="token punctuation">.</span>value
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">input</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>input <span class="token operator">=</span> input<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>按钮<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>实现思路是在创建节点时判断其 Virtual DOM 对象中是否有 ref 属性，如果有就调用 ref 属性中所存储的方法并且将创建出来的DOM对象作为参数传递给 ref 方法， 这样在渲染组件节点的时候就可以拿到元素对象并将元素对象存储为组件属性了。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// createDOMElement.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">ref</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在类组件的身上也可以添加 ref 属性，目的是获取组件的实例对象，比如下列代码中，在 DemoRef 组件中渲染了 Alert 组件，在 Alert 组件中添加了 ref 属性， 目的是在 DemoRef 组件中获取 Alert 组件实例对象。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">DemoRef</span> <span class="token keyword">extends</span> <span class="token class-name">TinyReact<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>input<span class="token punctuation">.</span>value
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alert<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;componentDidMount&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">input</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>input <span class="token operator">=</span> input<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>按钮<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Alert ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">alert</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alert <span class="token operator">=</span> alert<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>实现思路是在 mountComponent 方法中，如果判断了当前处理的是类组件，就通过类组件返回的 Virtual DOM 对象中获取组件实例对象， 判断组件实例对象中的 props 属性中是否存在 ref 属性，如果存在就调用 ref 方法并且将组件实例对象传递给 ref 方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// mountComponent.js</span>
<span class="token keyword">let</span> component <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunctionalComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 类组件</span>
    nextVirtualDOM <span class="token operator">=</span> <span class="token function">buildStatefulComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span>
    <span class="token comment">// 获取组件实例对象</span>
    component <span class="token operator">=</span> nextVirtualDOM<span class="token punctuation">.</span>component
  <span class="token punctuation">}</span>
	<span class="token comment">// 如果组件实例对象存在的话</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 组件完成挂载的生命周期函数</span>
      component<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   	<span class="token comment">// 判断组件实例对象身上是否有 props 属性 props 属性中是否有 ref 属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> component<span class="token punctuation">.</span>props<span class="token punctuation">.</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用 ref 方法并传递组件实例对象</span>
      component<span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">ref</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="key-属性" tabindex="-1"><a class="header-anchor" href="#key-属性" aria-hidden="true">#</a> key 属性</h2><p>在 React 中，一般会给循环渲染添加 key 属性，key属性帮助 React 快速更新数据和删除数据，从而达到 DOM 操作最小化的目的</p><h3 id="key-属性节点对比" tabindex="-1"><a class="header-anchor" href="#key-属性节点对比" aria-hidden="true">#</a> key 属性节点对比</h3><p>在两个元素进行对比时， 循环旧 dom 对象的子元素，将有key属性的族元素存储到一个对象中，借着循环新的vdom对象的子元素，在循环中获取这个子元素的key属性， 然后用这个key属性找到对应 对象中的 是否有这个元素，如果能找到 说明已存在，不需要渲染；如果找不到，说明需要新增</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// diff.js</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVirtualDOM <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> oldVirtualDOM<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将拥有key属性的元素放入 keyedElements 对象中</span>
  <span class="token keyword">let</span> keyedElements <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> domElement <span class="token operator">=</span> oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>domElement<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> domElement<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        keyedElements<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> domElement
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// diff.js</span>
<span class="token comment">// 看一看是否有找到了拥有 key 属性的元素</span>
<span class="token keyword">let</span> hasNoKey <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>keyedElements<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span>

<span class="token comment">// 如果没有找到拥有 key 属性的元素 就按照索引进行比较</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>hasNoKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 没有 递归对比 Virtual DOM 的子元素</span>
  virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">diff</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> oldDOM<span class="token punctuation">,</span> oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用key属性进行元素比较</span>
  virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取要进行比对的元素的 key 属性</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> child<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key
    <span class="token comment">// 如果 key 属性存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 到已存在的 DOM 元素对象中查找对应的 DOM 元素</span>
      <span class="token keyword">let</span> domElement <span class="token operator">=</span> keyedElements<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token comment">// 如果找到元素就说明该元素已经存在 不需要重新渲染</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>domElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 虽然 DOM 元素不需要重新渲染 但是不能确定元素的位置就一定没有发生变化</span>
        <span class="token comment">// 所以还要查看一下元素的位置</span>
        <span class="token comment">// 看一下 oldDOM 对应的(i)子元素和 domElement 是否是同一个元素 如果不是就说明元素位置发生了变化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> domElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 元素位置发生了变化</span>
          <span class="token comment">// 将 domElement 插入到当前元素位置的前面 oldDOM.childNodes[i] 就是当前位置</span>
          <span class="token comment">// domElement 就被放入了当前位置</span>
          oldDOM<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新增元素</span>
        <span class="token function">mountElement</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> oldDOM<span class="token punctuation">,</span> oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>这里新增元素不是所有的都放到最后的，根据最后一个元素是否存在，判断是否是插入</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// mountNativeElement.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>oldDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newElement<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将转换之后的DOM对象放置在页面中</span>
  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="节点卸载" tabindex="-1"><a class="header-anchor" href="#节点卸载" aria-hidden="true">#</a> 节点卸载</h3><p>在比对节点的过程中，如果旧节点的数量多于要渲染的新节点的数量就说明有节点被删除了， 继续判断 keyedElements 对象中是否有元素，如果没有就使用索引方式删除，如果有就要使用 key 属性比对的方式进行删除。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code> <span class="token comment">// 删除节点</span>
 <span class="token comment">// 获取旧节点</span>
 <span class="token keyword">let</span> oldChildNodes <span class="token operator">=</span> oldDOM<span class="token punctuation">.</span>childNodes
 <span class="token comment">// 如果旧节点的数量多于要渲染的新节点的长度</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildNodes<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNoKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 是否有key， 没有 普通删除</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span>
       <span class="token keyword">let</span> i <span class="token operator">=</span> oldChildNodes<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
       i <span class="token operator">&gt;</span> virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
       i<span class="token operator">--</span>
     <span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">unmountNode</span><span class="token punctuation">(</span>oldChildNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token comment">// 通过key属性删除节点</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldChildNodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">let</span> oldChild <span class="token operator">=</span> oldChildNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
       <span class="token keyword">let</span> oldChildKey <span class="token operator">=</span> oldChild<span class="token punctuation">.</span>_virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key
       <span class="token keyword">let</span> found <span class="token operator">=</span> <span class="token boolean">false</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildKey <span class="token operator">===</span> virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           found <span class="token operator">=</span> <span class="token boolean">true</span>
           <span class="token keyword">break</span>
         <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">unmountNode</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>卸载节点并不是说将节点直接删除就可以了，还需要考虑以下几种情况</p><ol><li>如果要删除的节点是文本节点的话可以直接删除</li><li>如果要删除的节点由组件生成，需要调用组件卸载生命周期函数</li><li>如果要删除的节点中包含了其他组件生成的节点，需要调用其他组件的卸载生命周期函数</li><li>如果要删除的节点身上有 ref 属性，还需要删除通过 ref 属性传递给组件的 DOM 节点对象</li><li>如果要删除的节点身上有事件，需要删除事件对应的事件处理函数</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取节点对应的 virtualDOM 对象</span>
  <span class="token keyword">const</span> virtualDOM <span class="token operator">=</span> dom<span class="token punctuation">.</span>_virtualDOM
  <span class="token comment">// 如果要删除的节点时文本</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接删除节点</span>
    dom<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 阻止程序向下运行</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 查看节点是否由组件生成</span>
  <span class="token keyword">let</span> component <span class="token operator">=</span> virtualDOM<span class="token punctuation">.</span>component
  <span class="token comment">// 如果由组件生成</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用组件卸载生命周期函数</span>
    component<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 如果节点具有 ref 属性 通过再次调用 ref 方法 将传递给组件的DOM对象删除</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 事件处理</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">propName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> eventHandler <span class="token operator">=</span> virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span>
      dom<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> eventHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
	
  <span class="token comment">// 递归删除子节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dom<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unmount</span><span class="token punctuation">(</span>dom<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      i<span class="token operator">--</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  	
  dom<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!----><!--]--></div>
    <script type="module" src="/blog/assets/app.6a7f8286.js" defer></script>
  </body>
</html>
